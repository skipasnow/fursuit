<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kemono Fursuit Makers</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://unpkg.com/tabulator-tables@5.6.0/dist/css/tabulator_midnight.min.css" rel="stylesheet">

<style>
  body {
    background: #2e2e2e;
    color: #fff;
    font-family: sans-serif;
    margin: 0;
    padding: 20px;
    /* Prevent Body scroll, let Table scroll */
    overflow: hidden; 
    height: 100vh; 
    box-sizing: border-box;
  }

  /* --- HEADER ANIMATION --- */
  h1 { 
    margin: 0 0 15px 0; 
    display: inline-block; 
    cursor: default;
    position: relative;
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    transform-origin: left center;
    white-space: nowrap;
  }

  h1:hover {
    transform: scale(1.15);
    background-image: linear-gradient(
      to right, 
      #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3, 
      #ff0000, #ff7f00, #ffff00
    );
    background-size: 200% auto;
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    color: transparent;
    animation: rainbow-move 2s linear infinite;
  }

  @keyframes rainbow-move { to { background-position: 200% center; } }

  .star-particle {
    position: fixed; top: 0; color: gold; font-size: 1.2em;
    pointer-events: none; z-index: 99999; user-select: none;
    text-shadow: 0 0 5px rgba(255, 215, 0, 0.8);
    animation: fall 1.5s linear forwards;
  }

  @keyframes fall {
    0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
    100% { transform: translateY(300px) rotate(180deg) scale(0.5); opacity: 0; }
  }

  /* --- CONTROLS --- */
  .controls-container {
    background: #1f1f1f; padding: 15px; border-radius: 8px; margin-bottom: 15px;
    display: flex; gap: 15px; align-items: center; flex-wrap: wrap; border: 1px solid #444;
  }
  .control-group { display: flex; align-items: center; gap: 10px; }
  select, button {
    padding: 8px 12px; border-radius: 4px; border: 1px solid #555;
    background: #333; color: #fff; cursor: pointer; font-size: 14px;
  }
  select:hover, button:hover { background: #444; border-color: darkorange; }
  button.reset-btn { background: #c62828; border-color: #e53935; }
  button.reset-btn:hover { background: #d32f2f; }
  label { font-weight: bold; color: #ccc; }

  /* --- TABLE CONTAINER --- */
  #creator-table {
    width: 100%;
    /* FIX: Strict height calculation ensures scrollbar stays on screen */
    height: calc(100vh - 180px); 
    border: 1px solid #444;
  }

  /* --- PREVIEW & LOGO BOXES --- */
  .preview-container { display: flex; gap: 2px; flex-wrap: wrap; justify-content: center; }
  .preview-box, .logo-box {
    display: inline-block; width: 30px; height: 30px;
    background-size: cover; background-position: center;
    border-radius: 4px; cursor: pointer; border: 1px solid #555; box-sizing: border-box;
  }
  .preview-box:hover, .logo-box:hover { border-color: darkorange; box-shadow: 0 0 5px rgba(255,140,0,0.5); }

  /* --- FLOATING TOOLTIP --- */
  #image-tooltip {
    display: none; position: fixed; width: 400px; height: 400px;
    background-color: #222; background-size: contain; background-repeat: no-repeat;
    background-position: center; border: 2px solid #fff;
    box-shadow: 0 0 20px rgba(0,0,0,0.7); z-index: 99999; pointer-events: none;
    opacity: 0; transition: opacity 0.25s ease-out, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  /* --- TABULATOR STYLES & OVERRIDES --- */
  
  /* FIX: Force Headers to Expand */
  .tabulator .tabulator-header { 
    height: auto !important; 
    background-color: #1f1f1f !important; 
    font-weight: bold !important;
    white-space: normal !important; 
  }
  
  .tabulator .tabulator-header .tabulator-col,
  .tabulator .tabulator-header .tabulator-col-content {
    height: auto !important;
    min-height: 40px; 
  }
  
  .tabulator .tabulator-header .tabulator-header-filter {
    height: auto !important;
    overflow: visible !important;
    margin-top: 5px;
  }

  .tabulator .tabulator-row .tabulator-cell { border: 1px solid #444; }
  .tabulator .tabulator-row:nth-child(even) { background-color: #383838; }
  .tabulator .tabulator-row:nth-child(odd) { background-color: #2e2e2e; }

  /* Base Cell Transition */
  .tabulator-row .tabulator-cell {
    transition: transform 0.1s ease-out, filter 0.2s ease, box-shadow 0.2s ease, font-size 0.2s ease, font-weight 0.2s ease;
    position: relative; 
    background-clip: padding-box;
  }

  /* 1. ACTIVE TILT STATE */
  .tabulator-row .tabulator-cell.active-tilt {
    z-index: 10000 !important; 
    box-shadow: 0 15px 30px rgba(0,0,0,0.6);
    border-color: rgba(255,255,255,0.5) !important; 
    filter: brightness(1.2);
    /* FIX: Only allow overflow when actively hovering to keep headers aligned */
    overflow: visible !important; 
  }

  /* 2. URL/LINK ANIMATION */
  a { color: darkorange !important; text-decoration: none; transition: all 0.2s; }
  .tabulator-row .tabulator-cell.active-tilt a {
    display: inline-block; color: #ffd699 !important;
    transform: translateY(-4px) scale(1.2);
    text-shadow: 0 0 8px rgba(255, 140, 0, 0.8), 0 0 15px rgba(255, 140, 0, 0.6);
    transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative; z-index: 10001;
  }

  /* 3. TEXT WRAPPER STYLING */
  .text-wrapper {
    display: block; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    transition: all 0.2s ease; transform-origin: center center;
  }
  .tabulator-row .tabulator-cell.active-tilt .text-wrapper {
    position: absolute; left: 0; top: 50%;
    width: max-content; min-width: 100%;
    background-color: rgba(40, 40, 40, 0.95);
    padding: 5px 10px; border-radius: 4px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.7); z-index: 100; pointer-events: auto;
  }

  /* 4. LIGHT SWEEP ANIMATION */
  .text-content { color: #fff; font-weight: normal; transition: font-weight 0.2s ease; }
  .tabulator-row .tabulator-cell.active-tilt .text-content {
    font-weight: bold;
    background: linear-gradient(110deg, #ffffff 40%, #ff8c00 50%, #ffffff 60%);
    background-size: 200% 100%; background-position: 200% center;
    -webkit-background-clip: text; background-clip: text;
    -webkit-text-fill-color: transparent; color: transparent;
    animation: shine-sweep 1.5s linear infinite;
  }
  @keyframes shine-sweep { 0% { background-position: 200% center; } 100% { background-position: -200% center; } }

  /* --- SPECIALTY TAG STYLES --- */
  .tag-wrapper { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; }
  .specialty-tag {
    background-color: #444; color: #fff; padding: 2px 6px;
    border-radius: 4px; font-size: 0.85em; cursor: pointer;
    border: 1px solid #555; transition: all 0.2s ease; font-weight: normal;
  }
  .specialty-tag:hover { background-color: darkorange; border-color: #fff; transform: scale(1.1); }

  /* --- HEADER FILTER STYLES --- */
  .filter-container {
    display: flex; flex-wrap: wrap; gap: 4px; padding: 6px;
    background: #222; border-radius: 4px; align-items: flex-start; 
    width: 100%; box-sizing: border-box; min-height: 65px; 
  }
  .filter-input {
    background: #333; color: #fff; border: 1px solid #555;
    padding: 4px 6px; border-radius: 3px; font-size: 0.85em;
    width: 100%; outline: none; margin-bottom: 4px;
  }
  .filter-input:focus { border-color: darkorange; }
  .filter-tag {
    background-color: darkorange; color: #fff; padding: 2px 6px;
    border-radius: 4px; font-size: 0.8em; display: flex; align-items: center; gap: 4px;
    animation: popIn 0.2s ease-out; margin-bottom: 2px;
  }
  @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
  .filter-remove { cursor: pointer; font-weight: bold; color: #000; font-size: 10px; }
  .filter-remove:hover { color: #fff; }
  .filter-actions {
      margin-top: 4px; width: 100%; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #444; padding-top: 4px;
  }
  .filter-clear-all {
    font-size: 0.8em; color: #ff6b6b; cursor: pointer; text-decoration: underline; white-space: nowrap;
  }
  .filter-clear-all:hover { color: #ff4040; }
  .filter-apply-btn {
    font-size: 0.8em; color: #4caf50; cursor: pointer; text-decoration: underline; white-space: nowrap; font-weight: bold;
  }
  .filter-apply-btn:hover { color: #66bb6a; }
  .tags-area { display: flex; flex-wrap: wrap; gap: 3px; width: 100%; }
</style>
</head>
<body>

<h1 id="page-header">Kemono Fursuit Makers</h1>

<div class="controls-container">
  <div class="control-group">
    <label>Quick Sort:</label>
    <select id="sort-field">
      <option value="rank">Rank (Default)</option>
      <option value="price">Price</option>
      <option value="portfolio">Portfolio Size</option>
      <option value="followers">Followers</option>
      <option value="acctAge">Account Age</option>
      <option value="partials">Partials Count</option>
      <option value="fursuits">Fursuits Count</option>
    </select>
  </div>
  <div class="control-group">
    <label>Order:</label>
    <select id="sort-dir">
      <option value="asc">Low to High (Asc)</option>
      <option value="desc">High to Low (Desc)</option>
    </select>
  </div>
  <button id="reset-sort" class="reset-btn">Reset Sort</button>
  <div style="margin-left: auto; font-size: 0.9em; color: #aaa; width: 100%; margin-top:10px;">
    *Hold <b>Shift</b> and click column headers to sort by multiple columns at once.
  </div>
</div>

<div id="image-tooltip"></div>
<div id="creator-table"></div>

<script src="https://unpkg.com/tabulator-tables@5.6.0/dist/js/tabulator.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQesC2Kuwk-4S3ID4cCsCvOGM4U0DstvIoewGKQn4pZII8mkoa6fxcN18ozOO3_EkISGIkKNVngLYdN/pub?gid=131139777&single=true&output=csv";

// --- TOOLTIP LOGIC ---
const tooltipEl = document.getElementById("image-tooltip");
let currentPreviewImages = [];
let currentImageIndex = 0;
let slideshowInterval;
let hideTimeout; 
let isTooltipCentered = false; 

function displayImageInTooltip(imageUrl, forceAnimation = false) {
    if (!imageUrl) { tooltipEl.style.backgroundImage = 'none'; return; }
    const baseTransform = isTooltipCentered ? "translate(-50%, -50%)" : "";
    if (tooltipEl.style.opacity === '0' || forceAnimation) {
        const startAngle = Math.random() < 0.5 ? -5 : 5;
        tooltipEl.style.transition = 'none';
        tooltipEl.style.opacity = '0';
        tooltipEl.style.transform = `${baseTransform} rotate(${startAngle}deg) scale(0.95)`;
    }
    const img = new Image();
    img.onload = () => {
        if (tooltipEl.style.display !== 'none') {
            tooltipEl.style.backgroundImage = `url('${imageUrl}')`;
            void tooltipEl.offsetWidth; 
            tooltipEl.style.transition = 'opacity 0.25s ease-out, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            tooltipEl.style.opacity = '1';
            tooltipEl.style.transform = `${baseTransform} rotate(0deg) scale(1)`;
        }
    };
    img.src = imageUrl;
}

function showTooltip(imageUrls, startIndex = 0, forceAnimation = false) {
    if (!imageUrls || imageUrls.length === 0) { hideTooltip(); return; }
    currentPreviewImages = imageUrls;
    currentImageIndex = startIndex;
    tooltipEl.style.display = "flex"; 
    displayImageInTooltip(currentPreviewImages[currentImageIndex], forceAnimation);
}

function hideTooltip() {
    clearTimeout(hideTimeout);
    clearInterval(slideshowInterval);
    hideTimeout = setTimeout(() => {
        tooltipEl.style.opacity = '0';
        setTimeout(() => {
             if(tooltipEl.style.opacity === '0') {
                 tooltipEl.style.display = "none";
                 tooltipEl.style.backgroundImage = 'none';
                 tooltipEl.textContent = ''; 
                 currentPreviewImages = [];
                 currentImageIndex = 0;
             }
        }, 200);
    }, 50);
}

function startSlideshow() {
    clearInterval(slideshowInterval);
    if (currentPreviewImages.length > 1) {
        slideshowInterval = setInterval(() => {
            currentImageIndex = (currentImageIndex + 1) % currentPreviewImages.length;
            displayImageInTooltip(currentPreviewImages[currentImageIndex], true);
        }, 2000);
    }
}

// --- POSITIONING LOGIC ---
function centerTooltip() {
    isTooltipCentered = true;
    tooltipEl.style.top = "50%";
    tooltipEl.style.left = "50%";
    tooltipEl.style.width = "80vh"; tooltipEl.style.height = "80vh";
}
function moveTooltip(e) {
    isTooltipCentered = false;
    const tooltipSize = 200; const offset = 15; 
    const windowHeight = window.innerHeight;
    tooltipEl.style.width = tooltipSize + "px"; tooltipEl.style.height = tooltipSize + "px";
    let left = e.clientX + offset; let top = e.clientY + offset;
    if (top + tooltipSize > windowHeight) { top = e.clientY - tooltipSize - offset; }
    tooltipEl.style.left = left + "px"; tooltipEl.style.top = top + "px";
}

// --- SPECIALTY FILTER LOGIC ---
let pendingSpecialtyFilters = new Set();
let appliedSpecialtyFilters = new Set();

window.addSpecialtyFilter = function(tag) {
    if(!tag) return;
    pendingSpecialtyFilters.add(tag.trim());
    updateFilterHeader();
    triggerHeaderResize(); // Force resize
}

window.removeSpecialtyFilter = function(tag) {
    pendingSpecialtyFilters.delete(tag);
    updateFilterHeader();
    triggerHeaderResize(); // Force resize
}

window.clearSpecialtyFilters = function() {
    pendingSpecialtyFilters.clear();
    appliedSpecialtyFilters.clear(); 
    updateFilterHeader();
    triggerHeaderResize();
    table.setHeaderFilterValue("specialty", []); 
}

window.applySpecialtyFilters = function() {
    appliedSpecialtyFilters = new Set(pendingSpecialtyFilters);
    table.setHeaderFilterValue("specialty", Array.from(appliedSpecialtyFilters));
}

// Helper to force Tabulator to redraw headers when content grows
function triggerHeaderResize() {
    if(table) table.columnManager.renderer.renderColumns();
}

function updateFilterHeader() {
    const container = document.getElementById('specialty-filter-container');
    if(!container) return;
    
    let tagsArea = container.querySelector('.tags-area');
    if (!tagsArea) {
        container.innerHTML = '';
        const input = document.createElement("input");
        input.type = "text";
        input.className = "filter-input";
        input.placeholder = "+ Type tag...";
        input.addEventListener("keydown", function(e){
            if(e.key === "Enter"){
                addSpecialtyFilter(this.value);
                this.value = "";
            }
        });
        container.appendChild(input);
        
        tagsArea = document.createElement("div");
        tagsArea.className = "tags-area";
        container.appendChild(tagsArea);
        
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'filter-actions';
        
        const applyBtn = document.createElement('span');
        applyBtn.className = 'filter-apply-btn';
        applyBtn.innerText = 'Apply Filter';
        applyBtn.onclick = window.applySpecialtyFilters;
        actionsDiv.appendChild(applyBtn);

        const clearBtn = document.createElement('span');
        clearBtn.className = 'filter-clear-all';
        clearBtn.innerText = 'Clear All';
        clearBtn.onclick = window.clearSpecialtyFilters;
        actionsDiv.appendChild(clearBtn);
        
        container.appendChild(actionsDiv);
    } 

    tagsArea.innerHTML = '';
    if (pendingSpecialtyFilters.size > 0) {
        pendingSpecialtyFilters.forEach(tag => {
            const pill = document.createElement('span');
            pill.className = 'filter-tag';
            pill.innerHTML = `${tag} <span class="filter-remove" onclick="removeSpecialtyFilter('${tag}')">✕</span>`;
            tagsArea.appendChild(pill);
        });
    } else {
        tagsArea.innerHTML = '<span style="color:#666; font-size:0.8em;">No tags selected</span>';
    }
}

// --- HELPERS ---
function parseImageFormula(formula) {
  if(!formula) return "";
  const match = formula.match(/=IMAGE\("(.+)"\)/);
  return match ? match[1] : formula;
}
function parsePreviewImages(urlsString) {
    if (!urlsString || typeof urlsString !== 'string') return [];
    return urlsString.split(' ').map(url => url.trim()).filter(url => url !== '');
}
function cleanNumber(val) {
    if (val === null || val === undefined || val === "") return null;
    if (typeof val === 'string') {
        const cleaned = val.replace(/[$,\s]/g, '');
        if(cleaned === "") return null;
        const num = parseFloat(cleaned);
        return isNaN(num) ? null : num;
    }
    return val; 
}
function getGradientColor(value, min, max, lowIsGreen=false){
    if(value === null || value === undefined || value === "" || isNaN(value)) return "";
    const ratio = (value - min)/(max - min);
    const cappedRatio = Math.min(Math.max(ratio,0),1);
    let r,g;
    if(lowIsGreen){
        r = Math.floor(179 * cappedRatio + 46 * (1-cappedRatio)); 
        g = Math.floor(27 * cappedRatio + 111 * (1-cappedRatio)); 
    } else {
        r = Math.floor(46 * cappedRatio + 179 * (1-cappedRatio));
        g = Math.floor(111 * cappedRatio + 27 * (1-cappedRatio));
    }
    return `rgb(${r},${g},0)`;
}
function formatTextCell(cell) {
    const val = cell.getValue();
    if(val === null || val === undefined) return "";
    return `<div class="text-wrapper"><span class="text-content">${val}</span></div>`;
}

// --- HEADER ANIMATION ---
const header = document.getElementById('page-header');
let starInterval;
function createStar() {
    const star = document.createElement('div');
    star.className = 'star-particle';
    star.textContent = '★';
    const headerRect = header.getBoundingClientRect();
    const startX = headerRect.left + (Math.random() * headerRect.width);
    const startY = headerRect.bottom - 10; 
    star.style.left = startX + 'px'; star.style.top = startY + 'px';
    const size = 0.8 + Math.random() * 0.8;
    star.style.fontSize = size + 'em';
    document.body.appendChild(star);
    setTimeout(() => { star.remove(); }, 1500);
}
header.addEventListener('mouseenter', () => { starInterval = setInterval(createStar, 50); });
header.addEventListener('mouseleave', () => { clearInterval(starInterval); });

// --- MAIN SCRIPT ---
let table;

Papa.parse(csvUrl, {
    download: true, header: true, dynamicTyping: true,
    complete: function(results) {
        const data = results.data.map(row => ({
            rank: cleanNumber(row['Rank']),
            maker: row['Maker'],
            logo: parseImageFormula(row['Logo']),
            makerType: row['Maker Type'],
            link: row['Link'],
            previewImages: parsePreviewImages(row['Preview']), 
            price: cleanNumber(row['$ Price']),
            shipOrFly: cleanNumber(row['$ Ship or Fly']),
            tariff: cleanNumber(row['$ Tariff (2025)']),
            ship: cleanNumber(row['$ Ship']),
            airTravel: cleanNumber(row['$ Air Travel']),
            travelSurplus: cleanNumber(row['$ Travel Surplus']),
            aesthetic: row['Aesthetic'],
            status: row['Status'],
            specialty: row['Specialty'],
            partials: cleanNumber(row['Partials']),
            fursuits: cleanNumber(row['Fursuits']),
            portfolio: cleanNumber(row['Portfolio Size']),
            country: row['Country'],
            followers: cleanNumber(row['Followers']), 
            acctAge: cleanNumber(row['Acct Age']),
            acctDate: row['Acct Date'],
            rep: row['Rep'],
            timeline: row['Timeline'],
            rankScore: cleanNumber(row['Rank Score']),
            imperfections: cleanNumber(row['Imperfections']),
            worksPerYear: cleanNumber(row['Works Per Year']),
            worksRank: cleanNumber(row['Works Rank']),
            followersRank: cleanNumber(row['Followers Rank']),
            acctDateRank: cleanNumber(row['Acct Date Rank']),
            partialsRank: cleanNumber(row['Partials Rank']),
            fursuitsRank: cleanNumber(row['Fursuits Rank']),
            priceRank: cleanNumber(row['Price Rank']),
        })).filter(row => row.maker); 

        if (data.length === 0) { console.warn("Data array is empty."); return; }

        const colMinMax = {};
        const gradientColumns = ['price','partials','fursuits','portfolio','acctAge','followers'];
        gradientColumns.forEach(col=>{
            const vals = data.map(d=>d[col]).filter(v=>v!==null && v!=="" && !isNaN(v));
            colMinMax[col] = {min: Math.min(...vals), max: Math.max(...vals)};
        });

        table = new Tabulator("#creator-table", {
            data: data,
            layout: "fitData",
            movableColumns: true,
            resizableColumns: true,
            placeholder:"No Data Available",
            height:"100%", 
            initialSort:[ {column:"rank", dir:"asc"} ],
            
            columns: [
                { title:"Rank", field:"rank", width:80, hozAlign:"center", sorter:"number", formatter: formatTextCell, cssClass: "text-cell" },
                { title:"Maker", field:"maker", formatter: formatTextCell, cssClass: "text-cell" },
                {
                    title:"Logo", field:"logo", hozAlign:"center", width:80,
                    formatter:function(cell){
                        const val = cell.getValue();
                        return val ? `<div class="logo-box" style="background-image:url('${val}');"></div>` : "";
                    }
                },
                { title:"Maker Type", field:"makerType", formatter: formatTextCell, cssClass: "text-cell" },
                {
                    title:"Link", field:"link", formatter:"link", hozAlign:"center",
                    formatterParams:{ labelField:"link", urlField:"link", target:"_blank" }
                },
                {
                    title: "Preview", field: "previewImages", hozAlign: "center", width: 200,
                    formatter: function(cell) {
                        const imageUrls = cell.getValue();
                        if (!imageUrls || imageUrls.length === 0) return "";
                        const container = document.createElement('div');
                        container.className = 'preview-container';
                        imageUrls.forEach((url, index) => {
                            const previewBox = document.createElement('div');
                            previewBox.className = 'preview-box';
                            previewBox.style.backgroundImage = `url('${url}')`;
                            previewBox.setAttribute('data-image-index', index);
                            container.appendChild(previewBox);
                        });
                        return container;
                    },
                },
                {
                    title:"$ Price", field:"price", hozAlign:"right", sorter:"number",
                    sorterParams:{ alignEmptyValues:"bottom" },
                    formatter:function(cell){
                        const val = cell.getValue();
                        if(val === null) return "N/A"; 
                        const c = getGradientColor(val,colMinMax['price'].min,colMinMax['price'].max,true);
                        cell.getElement().style.backgroundColor = c;
                        cell.getElement().style.color="#fff";
                        return val;
                    }
                },
                { title:"$ Ship or Fly", field:"shipOrFly", hozAlign:"right", sorter:"number", sorterParams:{ alignEmptyValues:"bottom" }, formatter: formatTextCell, cssClass: "text-cell" },
                { title:"$ Tariff (2025)", field:"tariff", hozAlign:"right", sorter:"number", sorterParams:{ alignEmptyValues:"bottom" }, formatter: formatTextCell, cssClass: "text-cell" },
                { title:"$ Ship", field:"ship", hozAlign:"right", sorter:"number", sorterParams:{ alignEmptyValues:"bottom" }, formatter: formatTextCell, cssClass: "text-cell" },
                { title:"$ Air Travel", field:"airTravel", hozAlign:"right", sorter:"number", sorterParams:{ alignEmptyValues:"bottom" }, formatter: formatTextCell, cssClass: "text-cell" },
                { title:"$ Travel Surplus", field:"travelSurplus", hozAlign:"right", sorter:"number", sorterParams:{ alignEmptyValues:"bottom" }, formatter: formatTextCell, cssClass: "text-cell" },
                
                { title:"Aesthetic", field:"aesthetic", formatter: formatTextCell, cssClass: "text-cell" },
                { title:"Status", field:"status", formatter: formatTextCell, cssClass: "text-cell" },
                
                // --- SPECIALTY FILTER ---
                {
                    title:"Specialty", 
                    field:"specialty", 
                    width: 250,
                    headerFilter: function(cell, onRendered, success, cancel, editorParams){
                        const container = document.createElement("div");
                        container.id = "specialty-filter-container";
                        container.className = "filter-container";
                        setTimeout(updateFilterHeader, 100); 
                        return container;
                    },
                    headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
                        if (!headerValue || headerValue.length === 0) return true;
                        if (!rowValue) return false;
                        const rowTags = rowValue.split(',').map(t => t.trim());
                        let match = false;
                        headerValue.forEach(filterTag => {
                            if (rowTags.includes(filterTag)) match = true;
                        });
                        return match;
                    },
                    formatter: function(cell) {
                        const val = cell.getValue();
                        if (!val) return "";
                        const tags = val.split(',').map(t => t.trim()).filter(t => t);
                        const wrapper = document.createElement('div');
                        wrapper.className = 'tag-wrapper';
                        
                        tags.forEach(tag => {
                            const span = document.createElement('span');
                            span.className = 'specialty-tag';
                            span.textContent = tag;
                            span.onclick = function(e) {
                                e.stopPropagation(); 
                                window.addSpecialtyFilter(tag);
                            };
                            wrapper.appendChild(span);
                        });
                        return wrapper;
                    }
                },

                {
                    title:"Partials", field:"partials", hozAlign:"right", sorter:"number",
                    sorterParams:{ alignEmptyValues:"bottom" },
                    formatter:function(cell){
                        const val = cell.getValue();
                        if(val === null) return "";
                        const c = getGradientColor(val,colMinMax['partials'].min,colMinMax['partials'].max,false);
                        cell.getElement().style.backgroundColor = c;
                        cell.getElement().style.color="#fff";
                        return val;
                    }
                },
                {
                    title:"Fursuits", field:"fursuits", hozAlign:"right", sorter:"number",
                    sorterParams:{ alignEmptyValues:"bottom" },
                    formatter:function(cell){
                        const val = cell.getValue();
                        if(val === null) return "";
                        const c = getGradientColor(val,colMinMax['fursuits'].min,colMinMax['fursuits'].max,false);
                        cell.getElement().style.backgroundColor = c;
                        cell.getElement().style.color="#fff";
                        return val;
                    }
                },
                {
                    title:"Portfolio Size", field:"portfolio", hozAlign:"right", sorter:"number",
                    sorterParams:{ alignEmptyValues:"bottom" },
                    formatter:function(cell){
                        const val = cell.getValue();
                        if(val === null) return "";
                        const c = getGradientColor(val,colMinMax['portfolio'].min,colMinMax['portfolio'].max,false);
                        cell.getElement().style.backgroundColor = c;
                        cell.getElement().style.color="#fff";
                        return val;
                    }
                },
                { title:"Country", field:"country", formatter: formatTextCell, cssClass: "text-cell" },
                {
                    title:"Followers", field:"followers", hozAlign:"right", sorter:"number",
                    sorterParams:{ alignEmptyValues:"bottom" },
                    formatter:function(cell){
                        const val = cell.getValue();
                        if(val === null) return "";
                        const displayVal = val.toLocaleString(); 
                        const c = getGradientColor(val,colMinMax['followers'].min,colMinMax['followers'].max,false);
                        cell.getElement().style.backgroundColor = c;
                        cell.getElement().style.color="#fff";
                        return displayVal;
                    }
                },
                {
                    title:"Acct Age", field:"acctAge", hozAlign:"right", sorter:"number",
                    sorterParams:{ alignEmptyValues:"bottom" }, 
                    formatter:function(cell){
                        const val = cell.getValue();
                        if(val === null) return "";
                        const c = getGradientColor(val,colMinMax['acctAge'].min,colMinMax['acctAge'].max,false);
                        cell.getElement().style.backgroundColor = c;
                        cell.getElement().style.color="#fff";
                        return val;
                    }
                },
                { title:"Acct Date", field:"acctDate", formatter: formatTextCell, cssClass: "text-cell" }
            ],
            rowFormatter:function(row){
                const el = row.getElement();
                if(row.getIndex()%2===0) el.style.backgroundColor="#383838";
                else el.style.backgroundColor="#2e2e2e";
            },
            reactiveData:true, virtualDom:true
        });

        // --- EVENT LISTENERS ---
        document.getElementById("reset-sort").addEventListener("click", function(){
            table.clearSort(); table.setSort("rank", "asc"); table.clearHeaderFilter(); 
            document.getElementById("sort-field").value = "rank";
            document.getElementById("sort-dir").value = "asc";
            window.clearSpecialtyFilters(); 
        });
        document.getElementById("sort-field").addEventListener("change", function(){
             const field = this.value; const dir = document.getElementById("sort-dir").value; table.setSort(field, dir);
        });
        document.getElementById("sort-dir").addEventListener("change", function(){
             const field = document.getElementById("sort-field").value; const dir = this.value; table.setSort(field, dir);
        });
    }
});

// --- GLOBAL HOVER TRACKING ---
let lastTiltCell = null; 
document.addEventListener('mousemove', (e) => {
    const target = e.target;
    const isOverPreview = target.closest('.preview-box');
    const isOverLogo = target.closest('.logo-box'); 
    const isOverTooltip = target.closest('#image-tooltip');
    
    // PART 1: REACTIVE TILT
    const cell = target.closest('.tabulator-cell');
    if (lastTiltCell && lastTiltCell !== cell) {
        const oldWrapper = lastTiltCell.querySelector('.text-wrapper');
        if (oldWrapper) oldWrapper.style.transform = '';
        lastTiltCell.style.transform = 'none';
        lastTiltCell.classList.remove('active-tilt');
        lastTiltCell = null;
    }
    if (cell) {
        lastTiltCell = cell;
        cell.classList.add('active-tilt');
        const rect = cell.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const mouseX = e.clientX - centerX;
        const mouseY = e.clientY - centerY;
        const rotateX = -1 * (mouseY / (rect.height / 2)) * 10; 
        const rotateY = (mouseX / (rect.width / 2)) * 10;
        const wrapper = cell.querySelector('.text-wrapper');
        const transformString = `perspective(500px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.15)`;
        
        if (wrapper) { wrapper.style.transform = `translateY(-50%) ${transformString}`; } 
        else if (!cell.querySelector('a') && !cell.querySelector('.tag-wrapper')) { 
             cell.style.transform = `perspective(500px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.05)`;
        }
    }

    // PART 2: TOOLTIP
    const sourceBox = isOverPreview || isOverLogo;
    if (sourceBox) {
        clearTimeout(hideTimeout);
        const rowEl = target.closest('.tabulator-row');
        if (rowEl && table) {
            const row = table.getRow(rowEl);
            if (row) {
                const rowData = row.getData();
                let imageUrls = []; let index = 0; let isLogo = false;
                if (isOverPreview) {
                    imageUrls = rowData.previewImages;
                    index = parseInt(sourceBox.getAttribute('data-image-index'), 10);
                    isLogo = false;
                } else if (isOverLogo) {
                    imageUrls = [rowData.logo]; index = 0; isLogo = true;
                }
                if (imageUrls && imageUrls.length > 0) {
                    const isNewContent = (currentPreviewImages[0] !== imageUrls[0] || currentPreviewImages.length !== imageUrls.length);
                    if (tooltipEl.style.display === 'none' || isNewContent || currentImageIndex !== index || isLogo) {
                        const shouldAnimate = (isNewContent || currentImageIndex !== index);
                        if (isLogo) {
                            clearInterval(slideshowInterval); moveTooltip(e); 
                            if (tooltipEl.style.display === 'none' || isNewContent) { showTooltip(imageUrls, index, true); }
                        } else {
                            clearInterval(slideshowInterval); centerTooltip(); 
                            if (isNewContent || currentImageIndex !== index) { showTooltip(imageUrls, index, shouldAnimate); } 
                            else { tooltipEl.style.display = "flex"; }
                        }
                    }
                }
            }
        }
    } else if (!isOverTooltip && tooltipEl.style.display !== 'none') { hideTooltip(); }
});
</script>

</body>
</html>
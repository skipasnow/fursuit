<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kemono Fursuit Makers</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Tabulator CSS -->
<link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">

<style>
body {
    background: #2e2e2e;
    color: #fff;
    font-family: sans-serif;
    padding: 20px;
    margin: 0;
}

h1 {
    color: #fff;
}

/* Tabulator dark theme */
.tabulator {
    background: #2e2e2e !important;
    color: #fff !important;
    border: 1px solid #555 !important;
}

/* Dark header row */
.tabulator .tabulator-header,
.tabulator .tabulator-header .tabulator-col,
.tabulator .tabulator-header .tabulator-col-group,
.tabulator .tabulator-header .tabulator-col .tabulator-col-content {
    background-color: #1f1f1f !important;
    color: #fff !important;
    border-bottom: 2px solid #555 !important;
}

/* Alternating dark rows */
.tabulator .tabulator-row.tabulator-row-even { background-color: #2a2a2a !important; }
.tabulator .tabulator-row.tabulator-row-odd { background-color: #3a3a3a !important; }

/* Table cells */
.tabulator .tabulator-cell { color: #fff !important; background-color: inherit !important; }

/* Links */
.tabulator .tabulator-cell a { color: #FF8C00 !important; text-decoration: underline; }
.tabulator .tabulator-cell a:visited { color: #FF8C00 !important; }
.tabulator .tabulator-cell a:hover { color: #FFA500 !important; }

/* Hover image tooltip */
#hover-image {
    position: absolute;
    display: none;
    width: 250px;
    height: 250px;
    border: 2px solid #fff;
    z-index: 1000;
    pointer-events: none;
    background-color: #2e2e2e;
    transition: opacity 0.2s ease-in-out;
}

/* Loader */
#loader {
    color: #fff;
    font-size: 18px;
    text-align: center;
    margin-top: 50px;
}
</style>
</head>
<body>

<h1>Kemono Fursuit Makers</h1>
<div id="loader">Loading data...</div>
<div id="creator-table"></div>
<img id="hover-image" src="" alt="Preview">

<!-- Dependencies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQesC2Kuwk-4S3ID4cCsCvOGM4U0DstvIoewGKQn4pZII8mkoa6fxcN18ozOO3_EkISGIkKNVngLYdN/pub?gid=131139777&single=true&output=csv";

// Function to map numeric value to gradient color
function valueToColor(value, min, max, reverse=false){
    if(value === "" || isNaN(value)) return "";
    let ratio = (value - min)/(max - min);
    if(reverse) ratio = 1 - ratio;
    let r = Math.floor(255 * ratio);
    let g = Math.floor(255 * (1 - ratio));
    return `rgb(${r},${g},0)`;
}

Papa.parse(csvUrl, {
    download: true,
    header: true,
    complete: function(results){
        const data = results.data.filter(row => row.Maker);

        if(!data.length){
            document.getElementById("loader").textContent = "No data found.";
            return;
        }

        document.getElementById("loader").style.display = "none";

        const numericCols = ["Price","Partials","Fursuits","Portfolio Size","Followers","Acct Age"];
        let minMax = {};
        numericCols.forEach(col=>{
            let numbers = data.map(row=>parseFloat(row[col])).filter(n=>!isNaN(n));
            minMax[col] = {min: Math.min(...numbers), max: Math.max(...numbers)};
        });

        const columns = Object.keys(data[0]).map(colName=>{
            if(colName === "Rank"){
                return { title: colName, field: colName, resizable:true, headerFilter:false, sorter:"number" };
            } else if(colName === "Specialty"){
                return { title: colName, field: colName, resizable:true, headerFilter:"input", sorter:"string" };
            } else if(colName === "Preview"){
                return {
                    title: colName,
                    field: colName,
                    resizable:true,
                    sorter:false,
                    formatter:function(cell){
                        const value = cell.getValue();
                        if(!value) return "";
                        return `<span class="preview-hover" data-src="${value}">Hover</span>`;
                    }
                };
            } else if(colName === "Link"){
                return {
                    title: colName,
                    field: colName,
                    resizable:true,
                    sorter:"string",
                    formatter:"link",
                    formatterParams:{labelField:colName,urlField:colName,target:"_blank"}
                };
            } else if(numericCols.includes(colName)){
                const reverse = ["Partials","Fursuits","Portfolio Size","Followers","Acct Age"].includes(colName);
                return {
                    title: colName,
                    field: colName,
                    resizable:true,
                    sorter:"number",
                    formatter:function(cell){
                        const val = parseFloat(cell.getValue());
                        const colMin = minMax[colName].min;
                        const colMax = minMax[colName].max;
                        const color = valueToColor(val, colMin, colMax, reverse);
                        return `<span style="color:${color}">${cell.getValue()}</span>`;
                    }
                };
            } else {
                return { title: colName, field: colName, resizable:true, sorter:"string" };
            }
        });

        const table = new Tabulator("#creator-table",{
            data: data,
            layout:"fitDataTable",
            columns: columns,
            movableColumns:true,
            height:"85vh",
            reactiveData:true,
            initialSort:[{column:"Rank", dir:"asc"}],
        });

        // Hover image tooltip
        const hoverImg = document.getElementById("hover-image");
        const container = document.querySelector("#creator-table");

        container.addEventListener("mousemove", function(e){
            const target = e.target.closest(".preview-hover");
            if(target){
                hoverImg.src = target.dataset.src;
                hoverImg.style.display = "block";
                hoverImg.style.opacity = 1;

                const vw = window.innerWidth;
                const vh = window.innerHeight;
                let left = e.pageX + 10;
                let top = e.pageY + 10;

                if(left + hoverImg.width > window.scrollX + vw){
                    left = e.pageX - hoverImg.width - 10;
                }
                if(top + hoverImg.height > window.scrollY + vh){
                    top = e.pageY - hoverImg.height - 10;
                }

                hoverImg.style.left = left + "px";
                hoverImg.style.top = top + "px";
            } else {
                hoverImg.style.opacity = 0;
                hoverImg.style.display = "none";
            }
        });
    }
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kemono Fursuit Makers</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://unpkg.com/tabulator-tables@5.6.0/dist/css/tabulator_midnight.min.css" rel="stylesheet">

<style>
  body {
    background: #2e2e2e;
    color: #fff;
    font-family: sans-serif;
    margin: 0;
    padding: 20px;
  }

  h1 { margin-bottom: 10px; }

  /* --- CONTROLS SECTION --- */
  .controls-container {
    background: #1f1f1f;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
    border: 1px solid #444;
  }

  .control-group {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  select, button {
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid #555;
    background: #333;
    color: #fff;
    cursor: pointer;
    font-size: 14px;
  }

  select:hover, button:hover {
    background: #444;
    border-color: darkorange;
  }

  button.action-btn {
    background: #e65100;
    border-color: #ff9800;
    font-weight: bold;
  }
  button.action-btn:hover { background: #ef6c00; }

  button.reset-btn {
    background: #c62828;
    border-color: #e53935;
  }
  button.reset-btn:hover { background: #d32f2f; }

  label {
    font-weight: bold;
    color: #ccc;
  }

  /* Restore pointer cursor since headerSort is disabled */
  .tabulator-col-content {
    cursor: pointer !important;
  }

  #creator-table {
    width: 100%;
    margin: auto;
    height: 80vh;
  }

  .hover-preview {
    display: inline-block;
    width: 30px;
    height: 30px;
    background-size: cover;
    background-position: center;
    border-radius: 4px;
    cursor: pointer;
  }

  /* THE FLOATING TOOLTIP */
  #image-tooltip {
    display: none; 
    position: fixed;
    width: 200px;
    height: 200px;
    background-color: #222;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    border: 2px solid #fff;
    box-shadow: 0 0 20px rgba(0,0,0,0.7);
    z-index: 99999;
    border-radius: 8px;
    pointer-events: none; 
  }

  .tabulator .tabulator-header { background-color: #1f1f1f !important; }
  a { color: darkorange; text-decoration: none; }
  a:hover { color: orange; }
  .tabulator .tabulator-row .tabulator-cell { border: 1px solid #444; }
  .tabulator .tabulator-row:nth-child(even) { background-color: #383838; }
  .tabulator .tabulator-row:nth-child(odd) { background-color: #2e2e2e; }
</style>
</head>
<body>

<h1>Kemono Fursuit Makers</h1>

<div class="controls-container">
  <div class="control-group">
    <label>Sort By:</label>
    <select id="sort-field">
      <option value="rank">Rank (Default)</option>
      <option value="price">Price</option>
      <option value="portfolio">Portfolio Size</option>
      <option value="followers">Followers</option>
      <option value="acctAge">Account Age</option>
      <option value="partials">Partials Count</option>
      <option value="fursuits">Fursuits Count</option>
    </select>
  </div>

  <div class="control-group">
    <label>Order:</label>
    <select id="sort-dir">
      <option value="asc">Low to High (Asc)</option>
      <option value="desc">High to Low (Desc)</option>
    </select>
  </div>

  <button id="apply-sort" class="action-btn">Apply / Execute Sort</button>
  <button id="reset-sort" class="reset-btn">Reset Default</button>
  
  <div style="margin-left: auto; font-size: 0.9em; color: #aaa; width: 100%; margin-top:10px;">
    <b>How to Multi-Sort:</b> Hold <b>Shift</b> and click headers to build a queue. The table will NOT update yet. Click <b>"Apply Sort"</b> when ready.
  </div>
</div>

<div id="image-tooltip"></div>
<div id="creator-table"></div>

<script src="https://unpkg.com/tabulator-tables@5.6.0/dist/js/tabulator.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQesC2Kuwk-4S3ID4cCsCvOGM4U0DstvIoewGKQn4pZII8mkoa6fxcN18ozOO3_EkISGIkKNVngLYdN/pub?gid=131139777&single=true&output=csv";

// --- TOOLTIP LOGIC ---
const tooltipEl = document.getElementById("image-tooltip");

function showTooltip(e, url) {
    if(!url) return;
    tooltipEl.style.backgroundImage = `url('${url}')`;
    tooltipEl.style.display = "block";
    moveTooltip(e); 
}
function hideTooltip() { tooltipEl.style.display = "none"; }
function moveTooltip(e) {
    const tooltipSize = 200; 
    const offset = 15; 
    const windowHeight = window.innerHeight;
    let left = e.clientX + offset;
    let top = e.clientY + offset;
    if (top + tooltipSize > windowHeight) top = e.clientY - tooltipSize - offset;
    tooltipEl.style.left = left + "px";
    tooltipEl.style.top = top + "px";
}

// --- HELPERS ---
function parseImageFormula(formula) {
  if(!formula) return "";
  const match = formula.match(/=IMAGE\("(.+)"\)/);
  return match ? match[1] : formula;
}

function cleanNumber(val) {
    if (val === null || val === undefined || val === "") return null;
    if (typeof val === 'string') {
        const cleaned = val.replace(/[$,\s]/g, '');
        if(cleaned === "") return null;
        const num = parseFloat(cleaned);
        return isNaN(num) ? null : num;
    }
    return val; 
}

function getGradientColor(value, min, max, lowIsGreen=false){
    if(value === null || value === undefined || value === "" || isNaN(value)) return "";
    const ratio = (value - min)/(max - min);
    const cappedRatio = Math.min(Math.max(ratio,0),1);
    let r,g;
    if(lowIsGreen){
        r = Math.floor(179 * cappedRatio + 46 * (1-cappedRatio)); 
        g = Math.floor(27 * cappedRatio + 111 * (1-cappedRatio)); 
    } else {
        r = Math.floor(46 * cappedRatio + 179 * (1-cappedRatio));
        g = Math.floor(111 * cappedRatio + 27 * (1-cappedRatio));
    }
    return `rgb(${r},${g},0)`;
}

// --- STATE MANAGEMENT ---
let table;
let currentSorts = []; 

// Global Column Definitions (Source of Truth)
// This allows us to always know the "Original Title" without guessing.
// NOTE: 'headerClick' is attached to this config, but processed later.
let baseColumnDefinitions = [];

// We define the updateVisuals function BEFORE we init the table
function updateHeaderVisuals() {
    // Loop through every active column in the table
    table.getColumns().forEach(col => {
        const field = col.getField();
        
        // Find the original base definition for this field to get the clean title
        const baseDef = baseColumnDefinitions.find(d => d.field === field);
        if(!baseDef) return; // Skip if not found (prevents undefined)

        const originalTitle = baseDef.title;
        
        // Check if this field is in our active sort stack
        const activeSort = currentSorts.find(s => s.column === field);
        const sortIndex = currentSorts.findIndex(s => s.column === field);

        if (activeSort) {
            const arrow = activeSort.dir === "asc" ? "▲" : "▼";
            const number = currentSorts.length > 1 ? `<small>(${sortIndex + 1})</small>` : "";
            col.updateDefinition({ title: `${originalTitle} ${arrow} ${number}` });
        } else {
            // Reset to original title
            col.updateDefinition({ title: originalTitle });
        }
    });
}

function handleHeaderClick(e, column) {
    const field = column.getField();
    // Columns to ignore sorting on
    const noSortCols = ['logo','link','preview','makerType','status','aesthetic','timeline','imperfections'];
    if(noSortCols.includes(field)) return;

    if (e.shiftKey) {
        // Deferred Sort Mode
        const existingIndex = currentSorts.findIndex(s => s.column === field);
        
        if (existingIndex > -1) {
            // Toggle direction
            currentSorts[existingIndex].dir = currentSorts[existingIndex].dir === "asc" ? "desc" : "asc";
        } else {
            // Add to stack
            currentSorts.push({ column: field, dir: "asc" });
        }
        updateHeaderVisuals();
    } else {
        // Instant Sort Mode
        const existingIndex = currentSorts.findIndex(s => s.column === field);
        let newDir = "asc";
        if(currentSorts.length === 1 && currentSorts[0].column === field) {
            newDir = currentSorts[0].dir === "asc" ? "desc" : "asc";
        }
        currentSorts = [{ column: field, dir: newDir }];
        updateHeaderVisuals();
        table.setSort(currentSorts);
        
        // Sync dropdowns
        document.getElementById("sort-field").value = field;
        document.getElementById("sort-dir").value = newDir;
    }
}

Papa.parse(csvUrl, {
    download: true, header: true, dynamicTyping: true,
    complete: function(results) {
        const data = results.data.map(row => ({
            rank: cleanNumber(row['Rank']),
            maker: row['Maker'],
            logo: parseImageFormula(row['Logo']),
            makerType: row['Maker Type'],
            link: row['Link'],
            preview: row['Preview'],
            price: cleanNumber(row['$ Price']),
            shipOrFly: row['$ Ship or Fly'],
            tariff: row['$ Tariff (2025)'],
            ship: row['$ Ship'],
            airTravel: row['$ Air Travel'],
            travelSurplus: row['$ Travel Surplus'],
            aesthetic: row['Aesthetic'],
            status: row['Status'],
            specialty: row['Specialty'],
            partials: cleanNumber(row['Partials']),
            fursuits: cleanNumber(row['Fursuits']),
            portfolio: cleanNumber(row['Portfolio Size']),
            country: row['Country'],
            followers: cleanNumber(row['Followers']), 
            acctAge: cleanNumber(row['Acct Age']),
            rep: row['Rep'],
            timeline: row['Timeline'],
            acctDate: row['Acct Date'],
            rankScore: row['Rank Score'],
            imperfections: row['Imperfections'],
            worksPerYear: row['Works Per Year'],
            worksRank: row['Works Rank'],
            followersRank: row['Followers Rank'],
            acctDateRank: row['Acct Date Rank'],
            partialsRank: row['Partials Rank'],
            fursuitsRank: row['Fursuits Rank'],
            priceRank: row['Price Rank']
        }));

        const colMinMax = {};
        const gradientColumns = ['price','partials','fursuits','portfolio','acctAge','followers'];
        gradientColumns.forEach(col=>{
            const vals = data.map(d=>d[col]).filter(v=>v!==null && v!=="" && !isNaN(v));
            colMinMax[col] = {min: Math.min(...vals), max: Math.max(...vals)};
        });

        // Define the columns config ONCE here.
        // We will use this variable to reset titles later.
        baseColumnDefinitions = [
            { title:"Rank", field:"rank", width:80, hozAlign:"center", sorter:"number", headerClick:handleHeaderClick },
            { title:"Maker", field:"maker", headerClick:handleHeaderClick },
            {
                title:"Logo", field:"logo", hozAlign:"center",
                formatter:function(cell){
                    const val = cell.getValue();
                    return val ? `<span class="hover-preview" style="background-image:url('${val}');"></span>` : "";
                }, 
                cellMouseEnter:function(e, cell){ showTooltip(e, cell.getValue()); },
                cellMouseLeave:function(e, cell){ hideTooltip(); },
                cellMouseMove:function(e, cell){ moveTooltip(e); }
            },
            { title:"Maker Type", field:"makerType" },
            {
                title:"Link", field:"link", formatter:"link", 
                formatterParams:{ labelField:"link", urlField:"link", target:"_blank" }
            },
            {
                title:"Preview", field:"preview", hozAlign:"center",
                formatter:function(cell){
                    const val = cell.getValue();
                    return val ? `<span class="hover-preview" style="background-image:url('${val}');"></span>` : "";
                }, 
                cellMouseEnter:function(e, cell){ showTooltip(e, cell.getValue()); },
                cellMouseLeave:function(e, cell){ hideTooltip(); },
                cellMouseMove:function(e, cell){ moveTooltip(e); }
            },
            {
                title:"Specialty", field:"specialty", headerClick:handleHeaderClick,
                headerFilter:"input", headerFilterPlaceholder:"Filter on specialty here..."
            },
            {
                title:"$ Price", field:"price", hozAlign:"right", sorter:"number", headerClick:handleHeaderClick,
                sorterParams:{ alignEmptyValues:"bottom" },
                formatter:function(cell){
                    const val = cell.getValue();
                    if(val === null) return "N/A"; 
                    const c = getGradientColor(val,colMinMax['price'].min,colMinMax['price'].max,true);
                    cell.getElement().style.backgroundColor = c;
                    cell.getElement().style.color="#fff";
                    return val;
                }
            },
            {
                title:"Partials", field:"partials", hozAlign:"right", sorter:"number", headerClick:handleHeaderClick,
                sorterParams:{ alignEmptyValues:"bottom" },
                formatter:function(cell){
                    const val = cell.getValue();
                    if(val === null) return "";
                    const c = getGradientColor(val,colMinMax['partials'].min,colMinMax['partials'].max,false);
                    cell.getElement().style.backgroundColor = c;
                    cell.getElement().style.color="#fff";
                    return val;
                }
            },
            {
                title:"Fursuits", field:"fursuits", hozAlign:"right", sorter:"number", headerClick:handleHeaderClick,
                sorterParams:{ alignEmptyValues:"bottom" },
                formatter:function(cell){
                    const val = cell.getValue();
                    if(val === null) return "";
                    const c = getGradientColor(val,colMinMax['fursuits'].min,colMinMax['fursuits'].max,false);
                    cell.getElement().style.backgroundColor = c;
                    cell.getElement().style.color="#fff";
                    return val;
                }
            },
            {
                title:"Portfolio Size", field:"portfolio", hozAlign:"right", sorter:"number", headerClick:handleHeaderClick,
                sorterParams:{ alignEmptyValues:"bottom" },
                formatter:function(cell){
                    const val = cell.getValue();
                    if(val === null) return "";
                    const c = getGradientColor(val,colMinMax['portfolio'].min,colMinMax['portfolio'].max,false);
                    cell.getElement().style.backgroundColor = c;
                    cell.getElement().style.color="#fff";
                    return val;
                }
            },
            {
                title:"Followers", field:"followers", hozAlign:"right", sorter:"number", headerClick:handleHeaderClick,
                sorterParams:{ alignEmptyValues:"bottom" },
                formatter:function(cell){
                    const val = cell.getValue();
                    if(val === null) return "";
                    const displayVal = val.toLocaleString(); 
                    const c = getGradientColor(val,colMinMax['followers'].min,colMinMax['followers'].max,false);
                    cell.getElement().style.backgroundColor = c;
                    cell.getElement().style.color="#fff";
                    return displayVal;
                }
            },
            {
                title:"Acct Age", field:"acctAge", hozAlign:"right", sorter:"number", headerClick:handleHeaderClick,
                sorterParams:{ alignEmptyValues:"bottom" }, 
                formatter:function(cell){
                    const val = cell.getValue();
                    if(val === null) return "";
                    const c = getGradientColor(val,colMinMax['acctAge'].min,colMinMax['acctAge'].max,false);
                    cell.getElement().style.backgroundColor = c;
                    cell.getElement().style.color="#fff";
                    return val;
                }
            },
            {title:"Status", field:"status"},
            {title:"Aesthetic", field:"aesthetic"},
            {title:"Timeline", field:"timeline"},
            {title:"Rank Score", field:"rankScore"},
            {title:"Imperfections", field:"imperfections"}
        ];

        table = new Tabulator("#creator-table", {
            data: data,
            layout: "fitData",
            movableColumns: true,
            resizableColumns: true,
            placeholder:"No Data Available",
            height:"80vh",
            headerSort: false, // Disable built-in sort
            columns: baseColumnDefinitions, // Use our source of truth
            rowFormatter:function(row){
                const el = row.getElement();
                if(row.getIndex()%2===0) el.style.backgroundColor="#383838";
                else el.style.backgroundColor="#2e2e2e";
            },
            reactiveData:true, virtualDom:true
        });

        // Init default Sort
        currentSorts = [{ column: "rank", dir: "asc" }];
        updateHeaderVisuals();
        table.setSort(currentSorts);

        // --- EVENT LISTENERS ---
        document.getElementById("apply-sort").addEventListener("click", function(){
            table.setSort(currentSorts);
        });

        document.getElementById("reset-sort").addEventListener("click", function(){
            currentSorts = [{ column: "rank", dir: "asc" }];
            updateHeaderVisuals();
            table.setSort(currentSorts);
            table.clearHeaderFilter(); 
            document.getElementById("sort-field").value = "rank";
            document.getElementById("sort-dir").value = "asc";
        });

        document.getElementById("sort-field").addEventListener("change", function(){
             const field = this.value;
             const dir = document.getElementById("sort-dir").value;
             currentSorts = [{ column: field, dir: dir }];
             updateHeaderVisuals();
             table.setSort(currentSorts);
        });

        document.getElementById("sort-dir").addEventListener("change", function(){
             const field = document.getElementById("sort-field").value;
             const dir = this.value;
             currentSorts = [{ column: field, dir: dir }];
             updateHeaderVisuals();
             table.setSort(currentSorts);
        });
    }
});
</script>

</body>
</html>
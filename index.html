<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kemono Fursuit Makers</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://unpkg.com/tabulator-tables@5.6.0/dist/css/tabulator_midnight.min.css" rel="stylesheet">

<style>
  body {
    background: #2e2e2e;
    color: #fff;
    font-family: sans-serif;
    margin: 0;
    padding: 20px;
  }

  h1 {
    margin-bottom: 10px;
  }

  /* --- CONTROLS SECTION --- */
  .controls-container {
    background: #1f1f1f;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
    border: 1px solid #444;
  }

  .control-group {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  select, button {
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid #555;
    background: #333;
    color: #fff;
    cursor: pointer;
    font-size: 14px;
  }

  select:hover, button:hover {
    background: #444;
    border-color: darkorange;
  }

  button.reset-btn {
    background: #d32f2f;
    border-color: #b71c1c;
  }
  button.reset-btn:hover {
    background: #f44336;
  }

  label {
    font-weight: bold;
    color: #ccc;
  }

  #creator-table {
    width: 100%;
    margin: auto;
    height: 80vh;
  }

  /* Thumbnail in the table */
  .hover-preview {
    display: inline-block;
    width: 30px;
    height: 30px;
    background-size: cover;
    background-position: center;
    border-radius: 4px;
    cursor: pointer;
  }

  /* THE FLOATING TOOLTIP */
  #image-tooltip {
    display: none; /* Hidden by default */
    position: fixed;
    width: 200px;
    height: 200px;
    background-color: #222;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    border: 2px solid #fff;
    box-shadow: 0 0 20px rgba(0,0,0,0.7);
    z-index: 99999;
    border-radius: 8px;
    pointer-events: none; 
  }

  /* Custom header color */
  .tabulator .tabulator-header {
    background-color: #1f1f1f !important;
  }

  /* URL styling */
  a {
    color: darkorange;
    text-decoration: none;
  }
  a:hover {
    color: orange;
  }

  /* Row borders */
  .tabulator .tabulator-row .tabulator-cell {
    border: 1px solid #444;
  }

  /* Alternating dark row colors */
  .tabulator .tabulator-row:nth-child(even) {
    background-color: #383838;
  }
  .tabulator .tabulator-row:nth-child(odd) {
    background-color: #2e2e2e;
  }
</style>
</head>
<body>

<h1>Kemono Fursuit Makers</h1>

<div class="controls-container">
  <div class="control-group">
    <label>Sort By:</label>
    <select id="sort-field">
      <option value="rank">Rank (Default)</option>
      <option value="price">Price</option>
      <option value="portfolio">Portfolio Size</option>
      <option value="followers">Followers</option>
      <option value="acctAge">Account Age</option>
      <option value="partials">Partials Count</option>
      <option value="fursuits">Fursuits Count</option>
    </select>
  </div>

  <div class="control-group">
    <label>Order:</label>
    <select id="sort-dir">
      <option value="asc">Low to High (Ascending)</option>
      <option value="desc">High to Low (Descending)</option>
    </select>
  </div>

  <button id="apply-sort">Apply Sort</button>
  <button id="reset-sort" class="reset-btn">Reset to Default</button>
  
  <div style="margin-left: auto; font-size: 0.9em; color: #aaa;">
    *Tip: Hold <b>Shift</b> and click column headers to multi-sort!
  </div>
</div>

<div id="image-tooltip"></div>

<div id="creator-table"></div>

<script src="https://unpkg.com/tabulator-tables@5.6.0/dist/js/tabulator.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQesC2Kuwk-4S3ID4cCsCvOGM4U0DstvIoewGKQn4pZII8mkoa6fxcN18ozOO3_EkISGIkKNVngLYdN/pub?gid=131139777&single=true&output=csv";

// --- TOOLTIP LOGIC ---
const tooltipEl = document.getElementById("image-tooltip");

function showTooltip(e, url) {
    if(!url) return;
    tooltipEl.style.backgroundImage = `url('${url}')`;
    tooltipEl.style.display = "block";
    moveTooltip(e); 
}

function hideTooltip() {
    tooltipEl.style.display = "none";
}

function moveTooltip(e) {
    const tooltipSize = 200; 
    const offset = 15; 
    const windowHeight = window.innerHeight;
    
    let left = e.clientX + offset;
    let top = e.clientY + offset;
    
    if (top + tooltipSize > windowHeight) {
        top = e.clientY - tooltipSize - offset;
    }

    tooltipEl.style.left = left + "px";
    tooltipEl.style.top = top + "px";
}

// --- DATA PARSING ---

function parseImageFormula(formula) {
  if(!formula) return "";
  const match = formula.match(/=IMAGE\("(.+)"\)/);
  return match ? match[1] : formula;
}

// Clean number helper
function cleanNumber(val) {
    if (val === null || val === undefined || val === "") return null;
    if (typeof val === 'string') {
        const cleaned = val.replace(/[$,\s]/g, '');
        if(cleaned === "") return null;
        const num = parseFloat(cleaned);
        return isNaN(num) ? null : num;
    }
    return val; 
}

function getGradientColor(value, min, max, lowIsGreen=false){
    if(value === null || value === undefined || value === "" || isNaN(value)) return "";
    
    const ratio = (value - min)/(max - min);
    const cappedRatio = Math.min(Math.max(ratio,0),1);
    
    let r,g;
    if(lowIsGreen){
        r = Math.floor(179 * cappedRatio + 46 * (1-cappedRatio)); 
        g = Math.floor(27 * cappedRatio + 111 * (1-cappedRatio)); 
    } else {
        r = Math.floor(46 * cappedRatio + 179 * (1-cappedRatio));
        g = Math.floor(111 * cappedRatio + 27 * (1-cappedRatio));
    }
    return `rgb(${r},${g},0)`;
}

// Global variable for the table instance
let table;

Papa.parse(csvUrl, {
    download: true,
    header: true,
    dynamicTyping: true,
    complete: function(results) {
        const data = results.data.map(row => ({
            // FIX 1: Apply cleanNumber to Rank to ensure it's a number
            rank: cleanNumber(row['Rank']),
            maker: row['Maker'],
            logo: parseImageFormula(row['Logo']),
            makerType: row['Maker Type'],
            link: row['Link'],
            preview: row['Preview'],
            price: cleanNumber(row['$ Price']),
            shipOrFly: row['$ Ship or Fly'],
            tariff: row['$ Tariff (2025)'],
            ship: row['$ Ship'],
            airTravel: row['$ Air Travel'],
            travelSurplus: row['$ Travel Surplus'],
            aesthetic: row['Aesthetic'],
            status: row['Status'],
            specialty: row['Specialty'],
            partials: cleanNumber(row['Partials']),
            fursuits: cleanNumber(row['Fursuits']),
            portfolio: cleanNumber(row['Portfolio Size']),
            country: row['Country'],
            followers: cleanNumber(row['Followers']), 
            acctAge: cleanNumber(row['Acct Age']),
            rep: row['Rep'],
            timeline: row['Timeline'],
            acctDate: row['Acct Date'],
            rankScore: row['Rank Score'],
            imperfections: row['Imperfections'],
            worksPerYear: row['Works Per Year'],
            worksRank: row['Works Rank'],
            followersRank: row['Followers Rank'],
            acctDateRank: row['Acct Date Rank'],
            partialsRank: row['Partials Rank'],
            fursuitsRank: row['Fursuits Rank'],
            priceRank: row['Price Rank']
        }));

        const colMinMax = {};
        const gradientColumns = ['price','partials','fursuits','portfolio','acctAge','followers'];
        
        gradientColumns.forEach(col=>{
            const vals = data.map(d=>d[col]).filter(v=>v!==null && v!=="" && !isNaN(v));
            colMinMax[col] = {min: Math.min(...vals), max: Math.max(...vals)};
        });

        table = new Tabulator("#creator-table", {
            data: data,
            layout: "fitData",
            movableColumns: true,
            resizableColumns: true,
            placeholder:"No Data Available",
            height:"80vh",
            initialSort:[
                {column:"rank", dir:"asc"} 
            ],
            columns: [
                // FIX 2: Added sorter:"number" explicitly
                {
                    title:"Rank", 
                    field:"rank", 
                    width:80, 
                    hozAlign:"center",
                    sorter:"number" 
                },
                {title:"Maker", field:"maker"},
                
                {
                    title:"Logo", field:"logo", 
                    formatter:function(cell){
                        const val = cell.getValue();
                        if(!val) return "";
                        return `<span class="hover-preview" style="background-image:url('${val}');"></span>`;
                    }, 
                    hozAlign:"center",
                    cellMouseEnter:function(e, cell){ showTooltip(e, cell.getValue()); },
                    cellMouseLeave:function(e, cell){ hideTooltip(); },
                    cellMouseMove:function(e, cell){ moveTooltip(e); }
                },
                
                {title:"Maker Type", field:"makerType"},
                
                {
                    title:"Link", 
                    field:"link", 
                    formatter:"link", 
                    formatterParams:{
                        labelField:"link", 
                        urlField:"link", 
                        target:"_blank"
                    }
                },
                
                {
                    title:"Preview", field:"preview", 
                    formatter:function(cell){
                        const val = cell.getValue();
                        if(!val) return "";
                        return `<span class="hover-preview" style="background-image:url('${val}');"></span>`;
                    }, 
                    hozAlign:"center",
                    cellMouseEnter:function(e, cell){ showTooltip(e, cell.getValue()); },
                    cellMouseLeave:function(e, cell){ hideTooltip(); },
                    cellMouseMove:function(e, cell){ moveTooltip(e); }
                },
                
                {
                    title:"Specialty", 
                    field:"specialty", 
                    headerFilter:"input",
                    headerFilterPlaceholder:"Filter on specialty here..."
                },
                
                {
                    title:"$ Price", 
                    field:"price", 
                    hozAlign:"right", 
                    sorter:"number",
                    sorterParams:{ alignEmptyValues:"bottom" },
                    formatter:function(cell){
                        const val = cell.getValue();
                        if(val === null || val==="") return "N/A"; 
                        const c = getGradientColor(val,colMinMax['price'].min,colMinMax['price'].max,true);
                        cell.getElement().style.backgroundColor = c;
                        cell.getElement().style.color="#fff";
                        return val;
                    }
                },
                {
                    title:"Partials", 
                    field:"partials", 
                    hozAlign:"right",
                    sorter:"number",
                    sorterParams:{ alignEmptyValues:"bottom" },
                    formatter:function(cell){
                        const val = cell.getValue();
                        if(val === null || val==="") return "";
                        const c = getGradientColor(val,colMinMax['partials'].min,colMinMax['partials'].max,false);
                        cell.getElement().style.backgroundColor = c;
                        cell.getElement().style.color="#fff";
                        return val;
                    }
                },
                {
                    title:"Fursuits", 
                    field:"fursuits", 
                    hozAlign:"right",
                    sorter:"number",
                    sorterParams:{ alignEmptyValues:"bottom" },
                    formatter:function(cell){
                        const val = cell.getValue();
                        if(val === null || val==="") return "";
                        const c = getGradientColor(val,colMinMax['fursuits'].min,colMinMax['fursuits'].max,false);
                        cell.getElement().style.backgroundColor = c;
                        cell.getElement().style.color="#fff";
                        return val;
                    }
                },
                {
                    title:"Portfolio Size", 
                    field:"portfolio", 
                    hozAlign:"right", 
                    sorter:"number",
                    sorterParams:{ alignEmptyValues:"bottom" },
                    formatter:function(cell){
                        const val = cell.getValue();
                        if(val === null || val==="") return "";
                        const c = getGradientColor(val,colMinMax['portfolio'].min,colMinMax['portfolio'].max,false);
                        cell.getElement().style.backgroundColor = c;
                        cell.getElement().style.color="#fff";
                        return val;
                    }
                },
                {
                    title:"Followers", 
                    field:"followers", 
                    hozAlign:"right", 
                    sorter:"number",
                    sorterParams:{ alignEmptyValues:"bottom" },
                    formatter:function(cell){
                        const val = cell.getValue();
                        if(val === null || val==="") return "";
                        const displayVal = val.toLocaleString(); 
                        const c = getGradientColor(val,colMinMax['followers'].min,colMinMax['followers'].max,false);
                        cell.getElement().style.backgroundColor = c;
                        cell.getElement().style.color="#fff";
                        return displayVal;
                    }
                },
                {
                    title:"Acct Age", 
                    field:"acctAge", 
                    hozAlign:"right",
                    sorter:"number",
                    sorterParams:{ alignEmptyValues:"bottom" }, 
                    formatter:function(cell){
                        const val = cell.getValue();
                        if(val === null || val==="") return "";
                        const c = getGradientColor(val,colMinMax['acctAge'].min,colMinMax['acctAge'].max,false);
                        cell.getElement().style.backgroundColor = c;
                        cell.getElement().style.color="#fff";
                        return val;
                    }
                },
                {title:"Status", field:"status"},
                {title:"Aesthetic", field:"aesthetic"},
                {title:"Timeline", field:"timeline"},
                {title:"Rank Score", field:"rankScore"},
                {title:"Imperfections", field:"imperfections"}
            ],
            rowFormatter:function(row){
                const el = row.getElement();
                if(row.getIndex()%2===0){
                    el.style.backgroundColor="#383838";
                } else {
                    el.style.backgroundColor="#2e2e2e";
                }
            },
            reactiveData:true,
            virtualDom:true,
        });

        // --- SORT EVENT LISTENERS ---
        
        // Auto-trigger sort when dropdowns change (New Feature)
        document.getElementById("sort-field").addEventListener("change", function(){
             const field = this.value;
             const dir = document.getElementById("sort-dir").value;
             table.setSort(field, dir);
        });

        document.getElementById("sort-dir").addEventListener("change", function(){
             const field = document.getElementById("sort-field").value;
             const dir = this.value;
             table.setSort(field, dir);
        });

        // Manual Apply Button
        document.getElementById("apply-sort").addEventListener("click", function(){
            const field = document.getElementById("sort-field").value;
            const dir = document.getElementById("sort-dir").value;
            table.setSort(field, dir);
        });

        // Reset Button
        document.getElementById("reset-sort").addEventListener("click", function(){
            document.getElementById("sort-field").value = "rank";
            document.getElementById("sort-dir").value = "asc";
            table.setSort("rank", "asc");
            table.clearHeaderFilter(); 
        });
    }
});
</script>

</body>
</html>
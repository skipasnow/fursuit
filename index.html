<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kemono Fursuit Makers</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Tabulator CSS -->
<link href="https://unpkg.com/tabulator-tables@5.6.0/dist/css/tabulator_midnight.min.css" rel="stylesheet">

<style>
  body {
    background: #2e2e2e;
    color: #fff;
    font-family: sans-serif;
    padding: 20px;
  }

  #creator-table {
    width: 85%;
    margin: auto;
  }

  .hover-preview {
    position: relative;
    display: inline-block;
  }

  .hover-preview:hover::after {
    content: '';
    position: absolute;
    top: 0;
    left: 100%;
    width: 200px;
    height: 200px;
    background-size: cover;
    border: 2px solid #fff;
    z-index: 100;
  }

  /* Custom header color */
  .tabulator .tabulator-header {
    background-color: #1f1f1f !important;
  }

  /* URL styling */
  a {
    color: darkorange;
    text-decoration: none;
  }
  a:hover {
    color: orange;
  }
</style>
</head>
<body>

<h1>Kemono Fursuit Makers</h1>
<div id="creator-table"></div>

<!-- Tabulator JS -->
<script src="https://unpkg.com/tabulator-tables@5.6.0/dist/js/tabulator.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQesC2Kuwk-4S3ID4cCsCvOGM4U0DstvIoewGKQn4pZII8mkoa6fxcN18ozOO3_EkISGIkKNVngLYdN/pub?gid=131139777&single=true&output=csv";

// Helper to parse =IMAGE("URL")
function parseImageFormula(formula) {
  const match = formula.match(/=IMAGE\("(.+)"\)/);
  return match ? match[1] : formula;
}

// Convert number strings with commas to numbers
function parseNumber(str){
  if(!str) return null;
  return Number(str.toString().replace(/,/g,''));
}

// Gradient color helper
function getGradientColor(value, min, max, reverse=false){
    if(value==null || isNaN(value)) return "#2e2e2e";
    const ratio = (value - min) / (max - min);
    const r = reverse ? Math.floor(255*(1-ratio)) : Math.floor(255*ratio);
    const g = reverse ? Math.floor(255*ratio) : Math.floor(255*(1-ratio));
    return `rgb(${r},${g},0)`;
}

Papa.parse(csvUrl, {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: function(results) {
    const rawData = results.data;
    console.log(rawData); // check CSV output

    // Map data to fields
    const data = rawData.map(row => ({
        rank: row['Rank'],
        maker: row['Maker'],
        logo: parseImageFormula(row['Logo']),
        makerType: row['Maker Type'],
        link: row['Link'],
        preview: row['Preview'],
        price: parseNumber(row['$ Price']),
        shipOrFly: parseNumber(row['$ Ship or Fly']),
        tariff: parseNumber(row['$ Tariff (2025)']),
        ship: parseNumber(row['$ Ship']),
        airTravel: parseNumber(row['$ Air Travel']),
        travelSurplus: parseNumber(row['$ Travel Surplus']),
        aesthetic: row['Aesthetic'],
        status: row['Status'],
        specialty: row['Specialty'],
        partials: parseNumber(row['Partials']),
        fursuits: parseNumber(row['Fursuits']),
        portfolio: parseNumber(row['Portfolio Size']),
        country: row['Country'],
        followers: parseNumber(row['Followers']),
        acctAge: parseNumber(row['Acct Age']),
        rep: row['Rep'],
        timeline: row['Timeline'],
        acctDate: row['Acct Date'],
        rankScore: parseNumber(row['Rank Score']),
        imperfections: parseNumber(row['Imperfections']),
        worksPerYear: parseNumber(row['Works Per Year']),
        worksRank: parseNumber(row['Works Rank']),
        followersRank: parseNumber(row['Followers Rank']),
        acctDateRank: parseNumber(row['Acct Date Rank']),
        partialsRank: parseNumber(row['Partials Rank']),
        fursuitsRank: parseNumber(row['Fursuits Rank']),
        priceRank: parseNumber(row['Price Rank'])
    }));

    // Compute min/max for gradient columns
    const numericCols = ['price','partials','fursuits','portfolio','followers','acctAge'];
    const colMinMax = {};
    numericCols.forEach(col=>{
      const vals = data.map(d=>d[col]).filter(v=>v!=null && !isNaN(v));
      colMinMax[col] = {min: Math.min(...vals), max: Math.max(...vals)};
    });

    // Initialize Tabulator
    new Tabulator("#creator-table", {
        data: data,
        layout:"fitDataTable",
        movableColumns:true,
        resizableColumns:true,
        columns:[
            {title:"Rank", field:"rank", width:60, hozAlign:"center"},
            {title:"Maker", field:"maker"},
            {title:"Logo", field:"logo", formatter:"image", formatterParams:{height:30}},
            {title:"Maker Type", field:"makerType"},
            {title:"Link", field:"link", formatter:"link", formatterParams:{labelField:"link", urlField:"link"}},
            {title:"Preview", field:"preview", formatter:function(cell){
                const val = cell.getValue();
                return val ? `<span class="hover-preview" style="background-image:url(${val}); width:30px; height:30px; display:inline-block;"></span>` : "";
            }, hozAlign:"center"},
            {title:"Specialty", field:"specialty", headerFilter:"input"},
            {title:"$ Price", field:"price", hozAlign:"right", formatter:function(cell){
                const val = cell.getValue();
                cell.getElement().style.backgroundColor = getGradientColor(val, colMinMax['price'].min, colMinMax['price'].max);
                return val;
            }},
            {title:"Partials", field:"partials", hozAlign:"right", formatter:function(cell){
                const val = cell.getValue();
                cell.getElement().style.backgroundColor = getGradientColor(val, colMinMax['partials'].min, colMinMax['partials'].max, true);
                return val;
            }},
            {title:"Fursuits", field:"fursuits", hozAlign:"right", formatter:function(cell){
                const val = cell.getValue();
                cell.getElement().style.backgroundColor = getGradientColor(val, colMinMax['fursuits'].min, colMinMax['fursuits'].max, true);
                return val;
            }},
            {title:"Portfolio Size", field:"portfolio", hozAlign:"right", formatter:function(cell){
                const val = cell.getValue();
                cell.getElement().style.backgroundColor = getGradientColor(val, colMinMax['portfolio'].min, colMinMax['portfolio'].max, true);
                return val;
            }},
            {title:"Followers", field:"followers", hozAlign:"right", formatter:function(cell){
                const val = cell.getValue();
                cell.getElement().style.backgroundColor = getGradientColor(val, colMinMax['followers'].min, colMinMax['followers'].max, true);
                return val;
            }},
            {title:"Acct Age", field:"acctAge", hozAlign:"right", formatter:function(cell){
                const val = cell.getValue();
                cell.getElement().style.backgroundColor = getGradientColor(val, colMinMax['acctAge'].min, colMinMax['acctAge'].max);
                return val;
            }},
            // Other columns as standard text
            {title:"Status", field:"status"},
            {title:"Aesthetic", field:"aesthetic"},
            {title:"Timeline", field:"timeline"},
            {title:"Rank Score", field:"rankScore"},
            {title:"Imperfections", field:"imperfections"}
        ],
        rowFormatter:function(row){
            const el = row.getElement();
            el.style.backgroundColor = (row.getIndex()%2===0) ? "#383838" : "#2e2e2e";
        }
    });
  }
});
</script>

</body>
</html>

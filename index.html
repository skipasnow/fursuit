<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kemono Fursuit Makers</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Tabulator CSS -->
<link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">

<style>
  body {
    background-color: #2e2e2e;
    color: #ffffff;
    font-family: sans-serif;
    padding: 20px;
  }

  .hover-preview {
    display: inline-block;
    width: 40px;
    height: 40px;
    background-size: cover;
    background-position: center;
    border-radius: 4px;
    border: 1px solid #555;
  }

  /* Dark header row */
  .tabulator .tabulator-header {
    background-color: #1f1f1f;
    color: #fff;
  }

  /* Orange links */
  .tabulator a {
    color: darkorange;
    text-decoration: none;
  }
  .tabulator a:visited {
    color: darkorange;
  }
  .tabulator a:hover {
    color: orange;
  }
</style>
</head>
<body>

<h1>Kemono Fursuit Makers</h1>
<div id="creator-table"></div>

<!-- PapaParse CSV parser -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<!-- Tabulator JS -->
<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQesC2Kuwk-4S3ID4cCsCvOGM4U0DstvIoewGKQn4pZII8mkoa6fxcN18ozOO3_EkISGIkKNVngLYdN/pub?gid=131139777&single=true&output=csv";

Papa.parse(csvUrl, {
  download: true,
  header: true,
  dynamicTyping: true,
  complete: function(results){
    const data = results.data.map(row => {
      const newRow = {};
      Object.keys(row).forEach(key => {
        let val = row[key];

        // Parse =IMAGE("URL") in Logo column
        if(key === "Logo" && typeof val === "string" && val.startsWith('=IMAGE')) {
          const match = val.match(/=IMAGE\("(.+)"\)/);
          val = match ? match[1] : "";
        }

        newRow[key] = val;
      });
      return newRow;
    });

    // Identify numeric columns for gradients
    const numericGradientCols = {
      "$ Price": "greenToRed",
      "Partials": "redToGreen",
      "Fursuits": "redToGreen",
      "Portfolio Size": "redToGreen",
      "Followers": "redToGreen",
      "Acct Age": "redToGreen"
    };

    // Create columns dynamically
    const columns = Object.keys(data[0]).map(col => {
      if(col === "Logo"){
        return {
          title: col,
          field: col,
          formatter:"image",
          formatterParams:{height:30},
          headerFilter:false,
        };
      }
      else if(col === "Preview"){
        return {
          title: col,
          field: col,
          formatter: function(cell){
            const val = cell.getValue();
            return val ? `<span class="hover-preview" style="background-image:url(${val});"></span>` : "";
          },
          headerFilter:false,
          hozAlign:"center"
        };
      }
      else if(col === "Specialty"){
        return {title: col, field: col, headerFilter:"input"};
      }
      else if(Object.keys(numericGradientCols).includes(col)){
        return {
          title: col,
          field: col,
          headerFilter:false,
          formatter:function(cell){
            const val = cell.getValue();
            const minMax = cell.getTable().getColumn(col).getDefinition()._minMax || [Infinity, -Infinity];
            if(val < minMax[0]) minMax[0] = val;
            if(val > minMax[1]) minMax[1] = val;
            cell.getColumn().getDefinition()._minMax = minMax;

            const min = minMax[0], max = minMax[1];
            if(val === null || val === undefined || val === "") return "";
            let color;
            if(numericGradientCols[col]==="greenToRed"){
              const ratio = (val-min)/(max-min);
              const r = Math.floor(255*ratio);
              const g = Math.floor(255*(1-ratio));
              color = `rgb(${r},${g},0)`;
            } else if(numericGradientCols[col]==="redToGreen"){
              const ratio = (val-min)/(max-min);
              const r = Math.floor(255*(1-ratio));
              const g = Math.floor(255*ratio);
              color = `rgb(${r},${g},0)`;
            }
            return `<span style="color:${color};font-weight:bold;">${val}</span>`;
          }
        };
      }
      else {
        return {title: col, field: col, headerFilter:false};
      }
    });

    new Tabulator("#creator-table", {
      data: data,
      layout:"fitDataTable",
      movableColumns:true,
      resizableColumns:true,
      columns: columns,
      rowFormatter:function(row){
        const el = row.getElement();
        if(row.getIndex() % 2 === 0){
          el.style.backgroundColor = "#383838";
        } else {
          el.style.backgroundColor = "#2e2e2e";
        }
      },
      height:"85vh", // extend table down the page
    });
  }
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kemono Fursuit Makers & Trip Estimator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://unpkg.com/tabulator-tables@5.6.0/dist/css/tabulator_midnight.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@5.6.0/dist/js/tabulator.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>

    <style>
        /* =========================================
           0. CUSTOM FONT CONFIGURATION
           ========================================= */
        @font-face {
            font-family: 'VCR OSD Mono';
            src: url('https://skipasnow.github.io/fursuit/fonts/VCR_OSD_MONO_1.001.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        /* =========================================
           1. GLOBAL LAYOUT & DEFAULTS
           ========================================= */
        html {
            min-height: 100%;
            margin: 0;
            padding: 0;
            background: #2e2e2e;
            color: #fff;
            /* Added CJK Font Fallbacks */
            font-family: 'VCR OSD Mono', 'Noto Sans TC', 'Noto Sans JP', 'Malgun Gothic', monospace, sans-serif;
        }

        body {
            min-height: 100vh;
            width: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            display: block; 
            overflow-y: auto; 
            overflow-x: hidden;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: darkorange; }

        /* Screen Shake Animation */
        body.shake-active { animation: screen-shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes screen-shake {
            10%, 90% { transform: translate3d(-2px, -2px, 0); }
            20%, 80% { transform: translate3d(4px, 4px, 0); }
            30%, 50%, 70% { transform: translate3d(-8px, -8px, 0); }
            40%, 60% { transform: translate3d(8px, 8px, 0); }
        }

        /* --- LAYOUT PANES --- */
        #top-pane {
            position: relative;
            z-index: 20; 
            background: #2e2e2e;
            padding: 20px;
            border-bottom: 2px solid #444;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }

        #table-pane {
            height: 85vh; 
            width: 100%;
            position: relative;
            z-index: 1; 
            background: #2e2e2e;
            margin-bottom: 40px; 
            padding-left: 20px; 
            padding-right: 20px;
            box-sizing: border-box;
        }
        
        #creator-table {
            position: absolute; 
            top: 0; left: 0; right: 0; bottom: 0;
            border: none;
        }

        h1 { margin: 0 0 15px 0; flex-shrink: 0; min-height: 60px; position: relative; }

        /* --- HEADER ANIMATION --- */
        #header-text {
            display: inline-block; position: relative;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-origin: left center; cursor: inherit;
        }
        #header-text:hover {
            transform: scale(1.15);
            background-image: linear-gradient(to right, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3, #ff0000, #ff7f00, #ffff00);
            background-size: 200% auto;
            -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent; color: transparent;
            animation: rainbow-move 2s linear infinite;
        }
        @keyframes rainbow-move { to { background-position: 200% center; } }

        /* --- COMBO COUNTER --- */
        #combo-counter {
            position: absolute; top: -15px; right: -20px;
            font-family: 'VCR OSD Mono', monospace; font-weight: bold;
            color: #ff5252; text-shadow: 2px 2px 0px #fff; opacity: 0; pointer-events: none;
            white-space: nowrap; z-index: 100; transform: rotate(-25deg) scale(1); 
            transition: opacity 0.2s ease, color 0.2s ease;
        }
        @keyframes combo-shake {
            0%, 100% { transform: rotate(-25deg) translate(0, 0) scale(var(--scale)); }
            20% { transform: rotate(-25deg) translate(-4px, 4px) scale(var(--scale)); }
            40% { transform: rotate(-25deg) translate(4px, -4px) scale(var(--scale)); }
            60% { transform: rotate(-25deg) translate(-4px, 4px) scale(var(--scale)); }
            80% { transform: rotate(-25deg) translate(4px, -4px) scale(var(--scale)); }
        }

        /* --- PARTICLES --- */
        .explosion-particle, .flame-particle { position: fixed; pointer-events: none; z-index: 9999; will-change: transform, opacity; }
        .explosion-particle {
            width: 6px; height: 6px; background-color: #fff;
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            animation: explode-debris 0.8s cubic-bezier(0.1, 0.8, 0.2, 1) forwards;
        }
        @keyframes explode-debris {
            0% { transform: translate(0, 0) scale(1) rotate(0deg); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0.5) rotate(720deg); opacity: 0; }
        }
        .flame-particle {
            width: 20px; height: 20px; border-radius: 50%;
            background: radial-gradient(circle, #fff 0%, #ffeb3b 30%, #ff9800 60%, transparent 100%);
            mix-blend-mode: screen; filter: blur(4px);
            animation: explode-flame 0.6s ease-out forwards;
        }
        @keyframes explode-flame {
            0% { transform: translate(0, 0) scale(0.5); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(3); opacity: 0; }
        }
        .blast-flash {
            position: absolute; top: 50%; left: 50%; width: 150%; height: 200%;
            transform: translate(-50%, -50%); background: white; opacity: 0; z-index: 200;
            pointer-events: none; border-radius: 50%; filter: blur(20px);
            animation: flash-bang 0.3s ease-out forwards;
        }
        @keyframes flash-bang {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(0.5); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(2); }
        }
        .scorch-mark {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) scale(0);
            width: 90%; height: 140px; background: radial-gradient(ellipse at center, rgba(0,0,0,0.9) 20%, rgba(34,15,15,0.7) 50%, rgba(0,0,0,0) 85%);
            border-radius: 50%; filter: blur(8px); z-index: 0; pointer-events: none;
            animation: scorch-appear 0.1s cubic-bezier(0.1, 0.9, 0.2, 1) forwards;
        }
        @keyframes scorch-appear { to { transform: translate(-50%, -50%) scale(1); } }

        /* --- COLLAPSIBLE SECTIONS --- */
        .collapsible-section {
            width: 100%; margin-bottom: 20px; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            max-height: 1000px;
            opacity: 1;
        }
        .collapsible-section.minimized {
            max-height: 0 !important;
            padding-top: 0 !important; padding-bottom: 0 !important; margin-bottom: 0 !important;
            border: none !important; opacity: 0 !important;
        }

        /* --- MAP SECTION --- */
        .map-section {
            padding: 15px; border: 1px solid #444; border-radius: 8px; background: #1f1f1f;
            display: grid; grid-template-columns: 2fr 1fr; gap: 20px; box-sizing: border-box;
        }
        @media (max-width: 1024px) { .map-section { grid-template-columns: 1fr; } }

        .map-column { position: relative; width: 100%; aspect-ratio: 5/3; min-height: 400px; }
        .map-container {
            position: absolute; inset: 0; background: #000;
            border: 2px solid #00E676; border-radius: 4px; overflow: hidden;
            background-image: linear-gradient(transparent 50%, rgba(0, 230, 118, 0.05) 50%);
            background-size: 100% 4px;
        }
        .data-column {
            display: flex; flex-direction: column; gap: 15px;
            background: #222; border: 1px solid #555; padding: 15px;
            border-radius: 4px; height: 100%; box-sizing: border-box;
        }
        .data-header-title { font-size: 1.4em; color: darkorange; margin-bottom: 5px; text-transform: uppercase; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .data-header-subtitle { font-size: 0.9em; color: #888; margin-bottom: 15px; }

        .tv-static {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; opacity: 0.08;
            background-image: url('data:image/svg+xml;utf8,%3Csvg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"%3E%3Cfilter id="noiseFilter"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.85" numOctaves="3" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="100%25" height="100%25" filter="url(%23noiseFilter)"/%3E%3C/svg%3E');
            animation: staticAnim 0.5s steps(5) infinite;
        }
        @keyframes staticAnim {
            0% { transform: translate(0,0); } 20% { transform: translate(-5%, -5%); }
            40% { transform: translate(-5%, 5%); } 60% { transform: translate(5%, -5%); }
            80% { transform: translate(5%, 5%); } 100% { transform: translate(0,0); }
        }

        .state { fill: transparent; stroke: #00E676; stroke-width: 1px; transition: stroke-width 0.3s ease; }
        .state:hover { stroke-width: 2px; }
        .heat-ring { fill: transparent; stroke-width: 1.5px; opacity: 0.7; mix-blend-mode: screen; }
        .airport-marker { fill: transparent; stroke: #D50000; stroke-width: 2px; cursor: pointer; transition: all 0.3s; transform-box: fill-box; transform-origin: center; }
        .airport-marker:hover { stroke: #FFCDD2; stroke-width: 3px; filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.8)); }

        #map-cost-card { display: flex; flex-direction: column; gap: 15px; opacity: 0.3; pointer-events: none; transition: opacity 0.3s ease; }
        #map-cost-card.active { opacity: 1; pointer-events: auto; }
        #select-prompt {
            color: #00E676; text-align: center; padding: 20px; border: 1px dashed #00E676;
            animation: blink 1.5s infinite; display: block; font-weight: bold;
        }
        #select-prompt.inactive { color: #444; border-color: #444; animation: none; background: #2a2a2a; }
        @keyframes blink { 50% { opacity: 0.5; } }
        
        .cost-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #333; padding-bottom: 5px; margin-bottom: 5px; }
        .cost-detail { font-size: 0.9em; color: #aaa; }
        .cost-highlight { font-size: 1.2em; color: #00E676; font-weight: bold; }
        .cost-total-display { font-size: 1.8em; color: darkorange; font-weight: bold; text-align: right; margin-top: 10px; }
        .cost-controls { border-top: 2px solid #444; padding-top: 15px; margin-top: auto; width: 100%; display: flex; flex-direction: column; gap: 12px; }
        .control-label { display: flex; align-items: center; gap: 10px; cursor: pointer; color: #eee; user-select: none; font-size: 0.95em; }
        .control-label:hover { background: #333; border-radius: 4px; }
        .control-label input { accent-color: darkorange; width: 18px; height: 18px; cursor: pointer; }
        .base-costs-list { display: flex; flex-wrap: wrap; gap: 10px; font-size: 0.8em; color: #777; margin-top: 10px; border-top: 1px dashed #333; padding-top: 10px; }
        .base-cost-item { display: flex; align-items: center; gap: 4px; }
        .base-cost-item::before { content: ">"; color: #00E676; }

        /* --- PROMO STATS SECTION --- */
        .analytics-section {
            display: flex; gap: 20px; margin-bottom: 20px;
            padding: 0; border-radius: 8px; flex-wrap: wrap;
            justify-content: space-between;
        }
        
        .promo-card {
            flex: 1; min-width: 300px;
            background: #1f1f1f;
            border: 2px solid;
            border-radius: 6px;
            padding: 20px;
            display: flex; flex-direction: column;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative; overflow: hidden;
            height: 220px;
        }

        /* Themes for Boxes */
        .theme-china { border-color: #ff8c00; box-shadow: inset 0 0 20px rgba(255, 140, 0, 0.1); }
        .theme-china .promo-title { color: #ff8c00; }
        .theme-china .promo-stat-large { color: #fff; text-shadow: 0 0 10px rgba(255, 140, 0, 0.5); }
        .theme-china .promo-bg-curve { fill: #ff8c00; }
        .theme-china .peak-range { color: #ff8c00; }

        .theme-japan { border-color: #00E676; box-shadow: inset 0 0 20px rgba(0, 230, 118, 0.1); }
        .theme-japan .promo-title { color: #00E676; }
        .theme-japan .promo-stat-large { color: #fff; text-shadow: 0 0 10px rgba(0, 230, 118, 0.5); }
        .theme-japan .promo-bg-curve { fill: #00E676; }
        .theme-japan .peak-range { color: #00E676; }

        .theme-korea { border-color: #00d4ff; box-shadow: inset 0 0 20px rgba(0, 212, 255, 0.1); }
        .theme-korea .promo-title { color: #00d4ff; }
        .theme-korea .promo-stat-large { color: #fff; text-shadow: 0 0 10px rgba(0, 212, 255, 0.5); }
        .theme-korea .promo-bg-curve { fill: #00d4ff; }
        .theme-korea .peak-range { color: #00d4ff; }

        .promo-bg-curve-container {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 60%;
            pointer-events: none; z-index: 0; opacity: 0.25;
        }
        
        .promo-content-layer {
            position: relative; z-index: 1;
            display: flex; height: 100%;
            justify-content: space-between;
        }

        .promo-left { flex: 1.2; display: flex; flex-direction: column; justify-content: space-between; padding-right: 15px; }
        .promo-right { 
            flex: 0.8; display: flex; flex-direction: column; justify-content: center; align-items: flex-end; text-align: right;
            border-left: 2px dashed #444; padding-left: 15px;
        }

        .promo-title { font-size: 1.5em; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 5px; }
        .promo-stat-large { font-size: 2.2em; font-weight: bold; line-height: 1; margin-top: 5px;}
        .promo-sub { font-size: 0.75em; color: #aaa; line-height: 1.3; }
        .promo-divider { height: 1px; background: #444; margin: 8px 0; border: none; width:100%; }

        .peak-label { font-size: 0.8em; color: #ccc; text-transform: uppercase; margin-bottom: 2px; }
        .peak-range { font-size: 1.3em; font-weight: bold; }

        /* --- CONTROLS --- */
        .controls-container {
            background: #1f1f1f; padding: 20px; border-radius: 8px; margin-bottom: 15px;
            display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap; border: 1px solid #444; flex-shrink: 0; 
        }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        select, button {
            padding: 8px 12px; border-radius: 4px; border: 1px solid #555; background: #333; 
            color: #fff; font-size: 14px; cursor: pointer !important; font-family: inherit;
        }
        select:hover, button:hover { background: #444; border-color: darkorange; }
        button.reset-btn { background: #c62828; border-color: #e53935; }
        button.reset-btn:hover { background: #d32f2f; }
        
        /* Toggle Buttons Style */
        .toggle-btn {
            background: #444; color: #fff; font-weight: bold; border-color: #666;
            min-width: 120px; transition: all 0.2s;
        }
        .toggle-btn.on { background: #00E676; color: #000; border-color: #00E676; }
        .toggle-btn.off { background: #333; color: #aaa; border-color: #555; }

        /* DATASET TOGGLE STYLES */
        .dataset-toggle { display: flex; gap: 0; border: 1px solid #555; border-radius: 4px; overflow: hidden; }
        .dataset-toggle button { 
            border: none; border-radius: 0; background: #333; color: #888; flex: 1; transition: all 0.2s; 
            white-space: nowrap; 
        }
        .dataset-toggle button.active { background: #ff8c00; color: #000; font-weight: bold; }
        .dataset-toggle button:hover:not(.active) { background: #444; color: #fff; }

        .results-counter { width: 100%; margin-top: 15px; padding-top: 15px; border-top: 1px solid #444; font-size: 1.1em; text-align: center; color: #ccc; }
        .results-counter b { color: #ff8c00; font-size: 1.2em; }
        .controls-footer { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid #444; flex-wrap: wrap; gap: 10px; }
        .results-counter { text-align: left; border-top: none; margin-top: 0; padding-top: 0; width: auto; }
        .sort-hint { font-size: 0.9em; color: #aaa; text-align: right; }
        
        .slider-group, .specialty-group { flex: 1 1 100% !important; width: 100% !important; max-width: 600px; display: flex; box-sizing: border-box; }
        .slider-group { flex-direction: column; order: -2; padding: 0 15px; margin-bottom: 40px; }
        .specialty-group { flex-direction: row; align-items: flex-start; order: -1; margin-bottom: 20px; gap: 15px; }
        .specialty-group > label { margin-top: 8px; white-space: nowrap; }

        /* Slider & Table Styles */
        .noUi-target { background: #555; border: 1px solid #000; border-radius: 4px; height: 8px; margin-top: 10px; cursor: pointer; }
        .noUi-connect { background: #ff8c00 !important; }
        .noUi-handle { width: 24px; height: 24px; border-radius: 50%; top: -9px; right: -12px; background: #eee; border: 2px solid #ff8c00; box-shadow: 0 2px 6px rgba(0,0,0,0.6); cursor: grab; outline: none; }
        .noUi-handle:before, .noUi-handle:after { display: none; }
        .noUi-pips { font-family: inherit; font-size: 11px; color: #aaa; height: 30px; top: 12px; }
        .noUi-marker { background: #555; width: 1px; } 
        .noUi-marker-large { background: #aaa; height: 10px; width: 2px; } 
        .noUi-value { color: #ccc; margin-top: 5px; }

        /* --- TABLE CONTAINER (FIXED) --- */
        #creator-table { width: 100%; height: 100%; border: none; }
        
        .tabulator .tabulator-header { background-color: #1f1f1f !important; font-weight: bold !important; border-bottom: 1px solid #444; }
        .tabulator .tabulator-row .tabulator-cell { border: 1px solid #444; font-size: 16px; }
        .tabulator .tabulator-row:nth-child(even) { background-color: #383838; }
        .tabulator .tabulator-row:nth-child(odd) { background-color: #2e2e2e; }

        .tabulator-row .tabulator-cell { transition: transform 0.1s ease-out; position: relative; background-clip: padding-box; overflow: hidden; }
        .tabulator-row .tabulator-cell.active-tilt { z-index: 10000 !important; box-shadow: 0 15px 30px rgba(0,0,0,0.6); border-color: rgba(255,255,255,0.5) !important; filter: brightness(1.2); overflow: visible !important; }
        .text-wrapper { display: block; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: all 0.2s ease; }
        .tabulator-row .tabulator-cell.active-tilt .text-wrapper { position: absolute; left: 0; top: 50%; min-width: 100%; width: max-content; background-color: rgba(40, 40, 40, 0.95); padding: 12px 20px; min-height: 45px; display: flex; align-items: center; border-radius: 4px; box-shadow: 0 10px 25px rgba(0,0,0,0.7); z-index: 100; pointer-events: auto; border: 1px solid #ffffff; }
        .text-content { color: #fff; font-weight: normal; }
        .tabulator-row .tabulator-cell.active-tilt .text-content { font-weight: bold; background: linear-gradient(110deg, #ffffff 40%, #ff8c00 50%, #ffffff 60%); background-size: 200% 100%; -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; color: transparent; animation: shine-sweep 1.5s linear infinite; }
        @keyframes shine-sweep { 0% { background-position: 200% center; } 100% { background-position: -200% center; } }
        
        .animated-link { color: darkorange; text-decoration: none; font-weight: bold; transition: all 0.3s; }
        .animated-link:hover {
            background-image: linear-gradient(to right, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
            background-size: 200% auto;
            -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow-move 2s linear infinite;
        }
        a { color: darkorange !important; text-decoration: none; }

        .filter-container { background: #222; border-radius: 4px; width: 100%; box-sizing: border-box; flex-grow: 1; padding: 8px; display: flex; flex-direction: column; gap: 6px; }
        .filter-input { background: #333; color: #fff; border: 1px solid #555; padding: 5px 8px; border-radius: 3px; font-family: inherit; width: 100%; box-sizing: border-box; }
        .filter-tag { background-color: darkorange; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-right: 3px; cursor: pointer; }
        .specialty-actions { display: flex; flex-direction: column; gap: 8px; white-space: nowrap; }
        .filter-apply-btn { color: #4caf50; cursor: pointer; text-decoration: underline; font-weight: bold; }
        .filter-clear-all { color: #ff6b6b; cursor: pointer; text-decoration: underline; }
        .tag-wrapper { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; }
        .specialty-tag { display: inline-block; background-color: #333; border: 1px solid #777; color: #eee; padding: 2px 6px; margin: 2px; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.5); position: relative; z-index: 50; }
        .specialty-tag:hover { background-color: #ff8c00; color: #000; border-color: #ff8c00; transform: scale(1.05); }

        .preview-box, .logo-box { width: 30px; height: 30px; background-color: #444; border: 1px solid #555; border-radius: 4px; cursor: pointer; background-size: cover; background-position: center; display: inline-block; position: relative; z-index: 20; }
        .preview-box:hover, .logo-box:hover { border-color: darkorange; }
        #image-tooltip { display: none; position: fixed; z-index: 99999; width: 60vmin; height: 60vmin; background-color: #222; border: 2px solid #fff; opacity: 0; background-size: contain; background-repeat: no-repeat; background-position: center; pointer-events: none; flex-direction: column; justify-content: flex-end; align-items: center; }
        .tooltip-hud { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; background: rgba(0, 0, 0, 0.6); padding: 8px 12px; border-radius: 20px; pointer-events: none; }
        .hud-box { width: 10px; height: 10px; border-radius: 50%; background: #555; border: 1px solid #888; transition: all 0.2s ease; }
        .hud-box.active { background: #ff8c00; border-color: #fff; transform: scale(1.3); box-shadow: 0 0 5px #ff8c00; }

        html, body, * { cursor: url('https://skipasnow.github.io/fursuit/images/cursor/pointer.svg') 0 0, auto; }
        html:active, body:active, *:active { cursor: url('https://skipasnow.github.io/fursuit/images/cursor/click.svg') 0 0, auto !important; }

        .star-particle { position: fixed; color: gold; pointer-events: none; animation: fall 1.5s linear forwards; z-index: 9999; }
        @keyframes fall { 0% { transform: translateY(0); opacity:1; } 100% { transform: translateY(300px); opacity:0; } }
        
        .legend-container { position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.8); padding:8px; border:2px solid #00E676; border-radius:4px; font-size:0.7em; z-index: 10; }
        .legend-title { color: #00E676; margin-bottom:4px; font-weight:bold; }
        .legend-gradient-retro { height: 10px; width: 100%; margin-bottom: 4px; background: linear-gradient(to right, #00E676 0%, #00E676 20%, #76FF03 20%, #76FF03 40%, #FFEA00 40%, #FFEA00 60%, #FF9100 60%, #FF9100 80%, #D50000 80%, #D50000 100%); }
        .legend-labels { display:flex; justify-content:space-between; color:#00E676; }
    </style>
</head>
<body>

    <div id="top-pane">
        <h1><span id="header-text">Kemono Fursuit Makers</span></h1>

        <div id="interactive-map-area" class="map-section collapsible-section">
            <div class="map-column">
                <div class="map-container">
                    <div class="tv-static"></div>
                    <div id="map-loading" style="position:absolute; inset:0; display:flex; justify-content:center; align-items:center;">
                        <div class="loader"></div>
                    </div>
                    <svg id="us-map" width="100%" height="100%" viewBox="0 0 975 610" preserveAspectRatio="xMidYMid meet"></svg>
                    <div class="legend-container">
                        <div class="legend-title">FLIGHT COST SIGNAL</div>
                        <div class="legend-gradient-retro"></div>
                        <div class="legend-labels"><span>LOW</span><span>HIGH</span></div>
                    </div>
                </div>
            </div>

            <div class="data-column">
                <div class="data-header-title" id="t-map-title">US/Asia Cost Map</div>
                <div class="data-header-subtitle" id="t-select-airport">Select Departure Airport</div>
                
                <div id="select-prompt">&lt; WAITING FOR SELECTION &gt;</div>

                <div id="map-cost-card" class="map-cost-card">
                    <div class="cost-header">
                        <div>
                            <div id="cost-city" style="font-size:1.3em; font-weight:bold; color:#fff;">City</div>
                            <div id="cost-airport" style="color:#aaa;">CODE</div>
                        </div>
                        <div>
                            <div class="cost-detail" id="t-flight">Roundtrip Flight</div>
                            <div id="cost-flight" class="cost-highlight">$0</div>
                        </div>
                        <div>
                            <div class="cost-detail" id="t-total-travel">TOTAL ESTIMATED TRAVEL</div>
                            <div id="cost-total-display" class="cost-total-display">$0</div>
                        </div>
                    </div>

                    <div class="cost-controls">
                        <div style="color:#00E676; font-weight:bold; margin-bottom:5px; border-bottom:1px solid #444; padding-bottom:5px;" id="t-config">CONFIGURATION:</div>
                        <label class="control-label"><input type="checkbox" id="check-visa" checked> <span id="t-visa">Passport & Visa</span></label>
                        <label class="control-label"><input type="checkbox" id="check-flight" checked> <span id="t-dom-flight">Domestic Flight</span></label>
                        <label class="control-label"><input type="checkbox" id="check-tourism" checked> <span id="t-tourism">Tourism</span></label>
                        <div class="base-costs-list">
                            <span id="t-base-incl">Base Included:</span>
                            <span class="base-cost-item" id="t-hotel">Hotel</span><span class="base-cost-item" id="t-food">Food</span><span class="base-cost-item" id="t-logistics">Logistics</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls-container">
          
          <div class="control-group">
            <label id="t-lang-label">Language:</label>
            <select id="language-selector">
                <option value="en">English (USD)</option>
                <option value="zh-TW">繁體中文 (CNY)</option>
                <option value="ja">日本語 (JPY)</option>
                <option value="ko">한국어 (KRW)</option>
            </select>
          </div>

          <div class="control-group">
            <label id="t-interface">Interface:</label>
            <div style="display:flex; gap:5px;">
                <button id="map-toggle-btn" class="toggle-btn on">Map: ENABLED</button>
                <button id="stats-toggle-btn" class="toggle-btn on">Stats: ENABLED</button>
            </div>
          </div>

          <div class="control-group">
              <label id="t-dataset">Dataset:</label>
              <div class="dataset-toggle">
                  <button id="btn-full" class="active">Full Suits</button>
                  <button id="btn-partial">Partial Suits</button>
              </div>
          </div>

          <div class="control-group slider-group">
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%; margin-bottom:10px;">
                <label>
                    <span id="t-price-label">Fursuit Price:</span> <span id="price-values" style="color:#ff8c00; font-weight:normal;">$2,000 - $10,000</span>
                    <button id="reset-price-btn" style="padding:2px 6px; margin-left:5px; font-size:0.8em; background:#444; border:1px solid #666; cursor:pointer;" title="Reset Price">↺</button>
                </label>
                <label style="font-size:0.8em; display:flex; align-items:center; gap:5px; cursor:pointer; user-select:none;">
                    <input type="checkbox" id="show-na-prices" checked> <span id="t-show-na">Show N/A Prices</span>
                </label>
            </div>
            <div id="price-slider"></div>
          </div>

          <div class="control-group specialty-group">
             <label id="t-specialty">Specialty Tags:</label>
             <div class="filter-container">
                 <input type="text" id="specialty-input" class="filter-input" placeholder="+ Type tag (e.g. 'kemono')...">
                 <div class="tags-area" id="specialty-tags-area">
                     <span style="color:#666; font-size:0.8em;" id="t-no-tags">No tags selected</span>
                 </div>
             </div>
             <div class="specialty-actions">
                 <span class="filter-apply-btn" id="specialty-apply-btn">Apply Filter</span>
                 <span class="filter-clear-all" id="specialty-clear-btn">Clear All</span>
             </div>
          </div>

          <div class="control-group">
            <label id="t-location">Location:</label>
            <select id="filter-location">
                <option value="" id="t-all-loc">All Locations</option>
                <option value="China" id="t-china">China</option>
                <option value="Japan" id="t-japan">Japan</option>
                <option value="Korea" id="t-korea">Korea</option>
            </select>
          </div>

          <div class="control-group">
            <label id="t-status">Status:</label>
            <select id="filter-status">
                <option value="" id="t-all-stats">All Statuses</option>
                <option value="Open" id="t-open">Open</option>
                <option value="Closed" id="t-closed">Closed</option>
            </select>
          </div>

          <div class="controls-footer">
              <div id="results-counter" class="results-counter">Loading data...</div>
              <div class="sort-hint" id="t-sort-hint">*Hold <b>Shift</b> and click column headers to sort by multiple columns.</div>
          </div>
        </div>

        <div id="analytics-area" class="analytics-section collapsible-section">
            </div>

    </div>

    <div id="table-pane">
        <div id="creator-table"></div>
    </div>

    <div id="image-tooltip"></div>

    <script>
        let currentLang = 'en';
        let globalTravelCost = 0;
        let currentSelectedFlightCost = 0;
        let table = null;
        let filterState = { priceMin: 2000, priceMax: 10000, showNA: true, tags: new Set(), location: "", status: "" };
        let pendingTags = new Set();
        let totalDataCount = 0;
        let loadedData = []; // Store raw data for language switching
        const costs = { base: 900, visa: 500, flightOption: 400, tourism: 300 };
        
        // Approximate Exchange Rates (Base USD)
        const exchangeRates = {
            'en': { rate: 1, symbol: '$' },
            'zh-TW': { rate: 7.2, symbol: '¥' }, // CNY
            'ja': { rate: 155, symbol: '¥' }, // JPY
            'ko': { rate: 1400, symbol: '₩' } // KRW
        };

        // --- TRANSLATION DICTIONARY ---
        const translations = {
            'en': {
                title: "Kemono Fursuit Makers",
                mapTitle: "US/Asia Cost Map",
                selectAirport: "Select Departure Airport",
                flight: "Roundtrip Flight",
                totalTravel: "TOTAL ESTIMATED TRAVEL",
                config: "CONFIGURATION:",
                visa: "Passport & Visa",
                domFlight: "Domestic Flight",
                tourism: "Tourism",
                baseIncl: "Base Included:",
                hotel: "Hotel", food: "Food", logistics: "Logistics",
                langLabel: "Language:",
                interface: "Interface:",
                mapEnabled: "Map: ENABLED", mapDisabled: "Map: DISABLED",
                statsEnabled: "Stats: ENABLED", statsDisabled: "Stats: DISABLED",
                dataset: "Dataset:",
                fullSuits: "Full Suits", partialSuits: "Partial Suits",
                priceLabel: "Fursuit Price:",
                showNA: "Show N/A Prices",
                specialty: "Specialty Tags:",
                placeholder: "+ Type tag (e.g. 'kemono')...",
                noTags: "No tags selected",
                apply: "Apply Filter", clear: "Clear All",
                location: "Location:", allLoc: "All Locations", china: "China", japan: "Japan", korea: "Korea",
                status: "Status:", allStats: "All Statuses", open: "Open", closed: "Closed",
                sortHint: "*Hold <b>Shift</b> and click column headers to sort by multiple columns.",
                loading: "Loading data...",
                
                // Analytics
                avgPrice: "Average Price",
                basedOn: "Based on",
                recorded: "recorded costumes",
                avgFollowers: "Average Followers",
                mostCommon: "Most Common Range",
                majority: "Majority of pricing falls here",

                // Table Columns
                colRow: "Row", colFreight: "Freight", colAesthetic: "Aesthetic", colMaker: "Maker",
                colLogo: "Logo", colLoc: "Location", colLink: "Link", colPreview: "Preview",
                colStatus: "Status", colSpecialty: "Specialty", colPartials: "Partials", colFull: "Full Suits",
                colFursuits: "Fursuits", colPort: "Portfolio Size", colFollowers: "Followers",
                colPrice: "Price", colTariff: "Tariff", colTotalShip: "Total (Ship)",
                colEstTravel: "Est. Travel", colTotalPick: "Total (Pick Up)", colSavings: "Pick Up Savings"
            },
            'zh-TW': {
                title: "獸裝製作師名錄 (Kemono)",
                mapTitle: "美亞旅行成本地圖",
                selectAirport: "選擇出發機場",
                flight: "往返機票",
                totalTravel: "預計旅行總費用",
                config: "配置:",
                visa: "護照與簽證",
                domFlight: "國內航班",
                tourism: "旅遊觀光",
                baseIncl: "基本包含:",
                hotel: "酒店", food: "餐飲", logistics: "物流",
                langLabel: "語言:",
                interface: "介面:",
                mapEnabled: "地圖: 啟用", mapDisabled: "地圖: 禁用",
                statsEnabled: "統計: 啟用", statsDisabled: "統計: 禁用",
                dataset: "數據集:",
                fullSuits: "全套獸裝", partialSuits: "半套獸裝",
                priceLabel: "獸裝價格:",
                showNA: "顯示 N/A 價格",
                specialty: "特長標籤:",
                placeholder: "+ 輸入標籤 (例: kemono)...",
                noTags: "未選擇標籤",
                apply: "應用篩選", clear: "清除全部",
                location: "地點:", allLoc: "所有地點", china: "中國", japan: "日本", korea: "韓國",
                status: "狀態:", allStats: "所有狀態", open: "開放", closed: "關閉",
                sortHint: "*按住 <b>Shift</b> 並點擊列標題可進行多列排序。",
                loading: "正在加載數據...",
                
                avgPrice: "平均價格",
                basedOn: "基於",
                recorded: "套記錄的服裝",
                avgFollowers: "平均關注者",
                mostCommon: "最常見範圍",
                majority: "多數定價落在此處",

                colRow: "行", colFreight: "運費", colAesthetic: "美學", colMaker: "製作師",
                colLogo: "標誌", colLoc: "地點", colLink: "連結", colPreview: "預覽",
                colStatus: "狀態", colSpecialty: "特長", colPartials: "半套", colFull: "全套",
                colFursuits: "獸裝數量", colPort: "作品集", colFollowers: "關注者",
                colPrice: "價格", colTariff: "關稅", colTotalShip: "總計 (郵寄)",
                colEstTravel: "預計旅行", colTotalPick: "總計 (自取)", colSavings: "自取節省"
            },
            'ja': {
                title: "ケモノ着ぐるみメーカー",
                mapTitle: "米・アジア渡航費マップ",
                selectAirport: "出発空港を選択",
                flight: "往復航空券",
                totalTravel: "推定渡航総額",
                config: "設定:",
                visa: "パスポートとビザ",
                domFlight: "国内線",
                tourism: "観光",
                baseIncl: "基本込み:",
                hotel: "ホテル", food: "食事", logistics: "物流",
                langLabel: "言語:",
                interface: "インターフェース:",
                mapEnabled: "地図: 有効", mapDisabled: "地図: 無効",
                statsEnabled: "統計: 有効", statsDisabled: "統計: 無効",
                dataset: "データセット:",
                fullSuits: "フルスーツ", partialSuits: "パートスーツ",
                priceLabel: "着ぐるみ価格:",
                showNA: "価格不明を表示",
                specialty: "専門タグ:",
                placeholder: "+ タグを入力 (例: kemono)...",
                noTags: "タグ未選択",
                apply: "フィルター適用", clear: "すべてクリア",
                location: "場所:", allLoc: "すべての場所", china: "中国", japan: "日本", korea: "韓国",
                status: "ステータス:", allStats: "すべてのステータス", open: "受付中", closed: "停止中",
                sortHint: "*<b>Shift</b> を押しながら列ヘッダーをクリックすると複数列でソートできます。",
                loading: "データを読み込んでいます...",
                
                avgPrice: "平均価格",
                basedOn: "記録された",
                recorded: "着に基づく",
                avgFollowers: "平均フォロワー数",
                mostCommon: "最頻価格帯",
                majority: "価格の大部分はここに該当",

                colRow: "行", colFreight: "貨物", colAesthetic: "美学", colMaker: "メーカー",
                colLogo: "ロゴ", colLoc: "場所", colLink: "リンク", colPreview: "プレビュー",
                colStatus: "ステータス", colSpecialty: "専門", colPartials: "パート", colFull: "フル",
                colFursuits: "着ぐるみ数", colPort: "ポートフォリオ", colFollowers: "フォロワー",
                colPrice: "価格", colTariff: "関税", colTotalShip: "合計 (配送)",
                colEstTravel: "推定渡航費", colTotalPick: "合計 (受取)", colSavings: "受取節約額"
            },
            'ko': {
                title: "케모노 퍼슈트 제작자",
                mapTitle: "미국/아시아 여행 비용 지도",
                selectAirport: "출발 공항 선택",
                flight: "왕복 항공권",
                totalTravel: "총 예상 여행 비용",
                config: "구성:",
                visa: "여권 및 비자",
                domFlight: "국내선",
                tourism: "관광",
                baseIncl: "기본 포함:",
                hotel: "호텔", food: "식사", logistics: "물류",
                langLabel: "언어:",
                interface: "인터페이스:",
                mapEnabled: "지도: 활성", mapDisabled: "지도: 비활성",
                statsEnabled: "통계: 활성", statsDisabled: "통계: 비활성",
                dataset: "데이터셋:",
                fullSuits: "풀슈트", partialSuits: "파셜슈트",
                priceLabel: "퍼슈트 가격:",
                showNA: "N/A 가격 표시",
                specialty: "전문 태그:",
                placeholder: "+ 태그 입력 (예: kemono)...",
                noTags: "태그 선택 안 됨",
                apply: "필터 적용", clear: "모두 지우기",
                location: "위치:", allLoc: "모든 위치", china: "중국", japan: "일본", korea: "한국",
                status: "상태:", allStats: "모든 상태", open: "오픈", closed: "마감",
                sortHint: "*<b>Shift</b> 키를 누른 채 열 헤더를 클릭하여 다중 열 정렬을 하세요.",
                loading: "데이터 로딩 중...",
                
                avgPrice: "평균 가격",
                basedOn: "기록된",
                recorded: "벌 기준",
                avgFollowers: "평균 팔로워",
                mostCommon: "가장 흔한 범위",
                majority: "대부분의 가격이 여기에 해당",

                colRow: "행", colFreight: "화물", colAesthetic: "미학", colMaker: "제작자",
                colLogo: "로고", colLoc: "위치", colLink: "링크", colPreview: "미리보기",
                colStatus: "상태", colSpecialty: "전문", colPartials: "파셜", colFull: "풀",
                colFursuits: "퍼슈트 수", colPort: "포트폴리오", colFollowers: "팔로워",
                colPrice: "가격", colTariff: "관세", colTotalShip: "총계 (배송)",
                colEstTravel: "예상 여행", colTotalPick: "총계 (픽업)", colSavings: "픽업 절약"
            }
        };

        // URLs
        const csvUrlFull = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQesC2Kuwk-4S3ID4cCsCvOGM4U0DstvIoewGKQn4pZII8mkoa6fxcN18ozOO3_EkISGIkKNVngLYdN/pub?gid=131139777&single=true&output=csv"; 
        const csvUrlPartial = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQesC2Kuwk-4S3ID4cCsCvOGM4U0DstvIoewGKQn4pZII8mkoa6fxcN18ozOO3_EkISGIkKNVngLYdN/pub?gid=38637980&single=true&output=csv"; 

        // Combo Vars
        let comboCount = 0;
        let comboTimeout;
        let isExploded = false;

        function formatCurrency(usdValue) {
            if (usdValue === null || isNaN(usdValue)) return "---";
            const info = exchangeRates[currentLang];
            const converted = usdValue * info.rate;
            return info.symbol + converted.toLocaleString(undefined, { maximumFractionDigits: 0 });
        }

        function applyLanguage() {
            const t = translations[currentLang];
            
            // Update Text Content
            const ids = {
                'header-text': t.title, 't-map-title': t.mapTitle, 't-select-airport': t.selectAirport,
                't-flight': t.flight, 't-total-travel': t.totalTravel, 't-config': t.config,
                't-visa': t.visa, 't-dom-flight': t.domFlight, 't-tourism': t.tourism,
                't-base-incl': t.baseIncl, 't-hotel': t.hotel, 't-food': t.food, 't-logistics': t.logistics,
                't-lang-label': t.langLabel, 't-interface': t.interface, 't-dataset': t.dataset,
                'btn-full': t.fullSuits, 'btn-partial': t.partialSuits, 't-price-label': t.priceLabel,
                't-show-na': t.showNA, 't-specialty': t.specialty, 't-no-tags': t.noTags,
                'specialty-apply-btn': t.apply, 'specialty-clear-btn': t.clear,
                't-location': t.location, 't-all-loc': t.allLoc, 't-china': t.china, 't-japan': t.japan, 't-korea': t.korea,
                't-status': t.status, 't-all-stats': t.allStats, 't-open': t.open, 't-closed': t.closed,
                't-sort-hint': t.sortHint
            };

            for (const [id, text] of Object.entries(ids)) {
                const el = document.getElementById(id);
                if(el) el.innerHTML = text; // InnerHTML to allow bold tags
            }

            document.getElementById('specialty-input').placeholder = t.placeholder;

            // Update Toggle Buttons Text (preserving state)
            const mapBtn = document.getElementById('map-toggle-btn');
            mapBtn.textContent = mapBtn.classList.contains('on') ? t.mapEnabled : t.mapDisabled;
            
            const statsBtn = document.getElementById('stats-toggle-btn');
            statsBtn.textContent = statsBtn.classList.contains('on') ? t.statsEnabled : t.statsDisabled;

            // Re-render Table (for Headers & Currency)
            if(loadedData.length > 0) initTable(loadedData);
            
            // Re-render Analytics
            if(loadedData.length > 0) updateAnalytics(loadedData);

            // Re-render Costs
            recalcCosts();

            // Re-render Slider Label
            const slider = document.getElementById('price-slider');
            if(slider && slider.noUiSlider) {
                const values = slider.noUiSlider.get();
                // We keep values in USD internally, but display converted
                document.getElementById('price-values').innerText = 
                    `${formatCurrency(values[0])} - ${formatCurrency(values[1])}`;
            }
        }

        // --- TOGGLE LOGIC ---
        function setupToggle(btnId, targetId, labelKeyEnabled, labelKeyDisabled) {
            const btn = document.getElementById(btnId);
            const target = document.getElementById(targetId);
            let isVisible = true;

            btn.addEventListener('click', () => {
                const t = translations[currentLang];
                isVisible = !isVisible;
                if(isVisible) {
                    target.classList.remove('minimized');
                    btn.classList.add('on');
                    btn.classList.remove('off');
                    btn.textContent = t[labelKeyEnabled];
                } else {
                    target.classList.add('minimized');
                    btn.classList.remove('on');
                    btn.classList.add('off');
                    btn.textContent = t[labelKeyDisabled];
                }
            });
        }
        setupToggle('map-toggle-btn', 'interactive-map-area', 'mapEnabled', 'mapDisabled');
        setupToggle('stats-toggle-btn', 'analytics-area', 'statsEnabled', 'statsDisabled');


        // --- FILTER LOGIC ---
        function masterFilter(row) {
            const price = row.price;
            let priceMatch = false;
            if (typeof price !== 'number') {
                priceMatch = filterState.showNA;
            } else {
                priceMatch = price >= filterState.priceMin && price <= filterState.priceMax;
            }
            if(!priceMatch) return false;

            if (filterState.location !== "" && row.country !== filterState.location) {
                return false;
            }

            if (filterState.status !== "" && row.status !== filterState.status) {
                return false;
            }

            if (filterState.tags.size > 0) {
                if (!row.specialty) return false; 
                const rowTags = row.specialty.split(',').map(t => t.trim());
                let tagMatch = false;
                filterState.tags.forEach(tag => { if (rowTags.includes(tag)) tagMatch = true; });
                return tagMatch;
            }
            return true;
        }

        function updateTableFilters() {
            if(table) {
                table.setFilter(masterFilter);
                setTimeout(refreshCounter, 10);
            }
        }

        function addSpecialtyFilter(tag) {
            if(!tag) return;
            pendingTags.add(tag.trim());
            updateSpecialtyUI();
        }
        window.removeSpecialtyFilter = function(tag) {
            pendingTags.delete(tag);
            updateSpecialtyUI();
        }
        function clearSpecialtyFilters() {
            pendingTags.clear();
            filterState.tags.clear();
            updateSpecialtyUI();
            updateTableFilters();
        }
        function applySpecialtyFilters() {
            filterState.tags = new Set(pendingTags);
            updateTableFilters();
        }
        function updateSpecialtyUI() {
            const t = translations[currentLang];
            const tagsArea = document.getElementById('specialty-tags-area');
            if(!tagsArea) return;
            tagsArea.innerHTML = '';
            if (pendingTags.size > 0) {
                pendingTags.forEach(tag => {
                    const pill = document.createElement('span');
                    pill.className = 'filter-tag';
                    pill.innerHTML = `${tag} <span class="filter-remove" style="color:black; font-weight:bold; cursor:pointer; margin-left:4px;" onclick="removeSpecialtyFilter('${tag}')">✕</span>`;
                    tagsArea.appendChild(pill);
                });
            } else {
                tagsArea.innerHTML = `<span style="color:#666; font-size:0.8em;">${t.noTags}</span>`;
            }
        }

        // --- MAP LOGIC ---
        const airports = [
            { city: "Honolulu", state: "HI", code: "HNL", cost: 1000, lat: 21.306, lon: -157.858 },
            { city: "Anchorage", state: "AK", code: "ANC", cost: 1000, lat: 61.218, lon: -149.900 },
            { city: "Kansas City", state: "MO", code: "MCI", cost: 1500, lat: 39.297, lon: -94.713 },
            { city: "Chicago", state: "IL", code: "ORD", cost: 1100, lat: 41.974, lon: -87.907 },
            { city: "Seattle", state: "WA", code: "SEA", cost: 700, lat: 47.450, lon: -122.311 },
            { city: "Portland", state: "OR", code: "PDX", cost: 1100, lat: 45.589, lon: -122.595 },
            { city: "San Francisco", state: "CA", code: "SFO", cost: 800, lat: 37.618, lon: -122.374 },
            { city: "Los Angeles", state: "CA", code: "LAX", cost: 800, lat: 33.941, lon: -118.408 },
            { city: "Las Vegas", state: "NV", code: "LAS", cost: 1000, lat: 36.084, lon: -115.153 },
            { city: "Phoenix", state: "AZ", code: "PHX", cost: 1200, lat: 33.434, lon: -112.011 },
            { city: "Salt Lake City", state: "UT", code: "SLC", cost: 1600, lat: 40.789, lon: -111.979 },
            { city: "Denver", state: "CO", code: "DEN", cost: 1200, lat: 39.856, lon: -104.673 },
            { city: "Dallas", state: "TX", code: "DFW", cost: 1200, lat: 32.899, lon: -97.040 },
            { city: "Minneapolis", state: "MN", code: "MSP", cost: 1200, lat: 44.884, lon: -93.216 },
            { city: "Nashville", state: "TN", code: "BNA", cost: 1500, lat: 36.126, lon: -86.677 },
            { city: "Indianapolis", state: "IN", code: "IND", cost: 1600, lat: 39.716, lon: -86.294 },
            { city: "Detroit", state: "MI", code: "DTW", cost: 1400, lat: 42.212, lon: -83.353 },
            { city: "Cleveland", state: "OH", code: "CLE", cost: 1300, lat: 41.405, lon: -81.853 },
            { city: "Charlotte", state: "NC", code: "CLT", cost: 1300, lat: 35.214, lon: -80.943 },
            { city: "Atlanta", state: "GA", code: "ATL", cost: 1200, lat: 33.640, lon: -84.426 },
            { city: "Orlando", state: "FL", code: "MCO", cost: 1300, lat: 28.428, lon: -81.311 },
            { city: "Washington", state: "DC", code: "DCA", cost: 1200, lat: 38.851, lon: -77.040 },
            { city: "Philadelphia", state: "PA", code: "PHL", cost: 1400, lat: 39.872, lon: -75.240 },
            { city: "New York City", state: "NY", code: "JFK", cost: 1000, lat: 40.641, lon: -73.778 },
            { city: "Boston", state: "MA", code: "BOS", cost: 1000, lat: 42.365, lon: -71.009 },
            { city: "Louisville", state: "KY", code: "SDF", cost: 1500, lat: 38.174, lon: -85.736 }
        ];

        function initMap() {
            const svg = d3.select("#us-map");
            const projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305]);
            const path = d3.geoPath().projection(projection);
            const costExtent = d3.extent(airports, d => d.cost);
            const colorScale = d3.scaleQuantize().domain(costExtent).range(["#00E676", "#76FF03", "#FFEA00", "#FF9100", "#D50000"]);

            d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json").then((us) => {
                document.getElementById('map-loading').style.display = 'none';
                airports.forEach(d => {
                    const coords = projection([d.lon, d.lat]);
                    if (coords) { d.x = coords[0]; d.y = coords[1]; d.visible = true; } else { d.visible = false; }
                });
                airports.forEach(d1 => {
                    if (!d1.visible) return;
                    let minDist = Infinity;
                    airports.forEach(d2 => {
                        if (d1 !== d2 && d2.visible) {
                            const dist = Math.hypot(d1.x - d2.x, d1.y - d2.y);
                            if (dist < minDist) minDist = dist;
                        }
                    });
                    d1.isolation = minDist;
                });
                const radiusScale = d3.scaleLinear().domain([20, 150]).range([25, 70]).clamp(true);
                svg.append("g").selectAll("path").data(topojson.feature(us, us.objects.states).features).join("path").attr("d", path).attr("class", "state");
                const spheres = svg.append("g").selectAll("g").data(airports).join("g").attr("transform", d => d.visible ? `translate(${d.x}, ${d.y})` : null).style("display", d => d.visible ? "block" : "none");
                spheres.each(function(d) {
                    const g = d3.select(this);
                    const r = radiusScale(d.isolation);
                    const color = colorScale(d.cost);
                    for(let i=1; i<=3; i++) { g.append("circle").attr("class", "heat-ring").attr("r", r * (i/3)).style("stroke", color); }
                });
                svg.append("g").selectAll("path").data(airports).join("path").attr("class", "airport-marker").attr("d", d3.symbol().type(d3.symbolDiamond).size(150)).attr("transform", d => d.visible ? `translate(${d.x}, ${d.y})` : null)
                    .on("mouseover", function() { d3.select(this).transition().attr("d", d3.symbol().type(d3.symbolDiamond).size(400)); })
                    .on("mouseout", function() { d3.select(this).transition().attr("d", d3.symbol().type(d3.symbolDiamond).size(150)); })
                    .on("click", handleAirportClick);
            });
        }

        function recalcCosts() {
            if(currentSelectedFlightCost === 0) return;
            const visaCost = document.getElementById('check-visa').checked ? costs.visa : 0;
            const flightOptCost = document.getElementById('check-flight').checked ? costs.flightOption : 0;
            const tourismCost = document.getElementById('check-tourism').checked ? costs.tourism : 0;
            const variableCosts = visaCost + flightOptCost + tourismCost;
            globalTravelCost = currentSelectedFlightCost + costs.base + variableCosts;
            document.getElementById('cost-total-display').textContent = formatCurrency(globalTravelCost);
            updateTableTravelData();
        }

        function handleAirportClick(event, d) {
            d3.selectAll(".airport-marker").style("stroke", "#D50000");
            d3.select(this).transition().duration(300).style("stroke", "#00E676");
            currentSelectedFlightCost = d.cost;
            const card = document.getElementById('map-cost-card');
            card.classList.add('active');
            const prompt = document.getElementById('select-prompt');
            prompt.classList.add('inactive');
            prompt.textContent = "< DATA LINK ACTIVE >";
            document.getElementById('cost-city').textContent = `${d.city}, ${d.state}`;
            document.getElementById('cost-airport').textContent = d.code;
            document.getElementById('cost-flight').textContent = formatCurrency(d.cost);
            recalcCosts();
        }

        // --- TABLE LOGIC ---
        function cleanNumber(val) {
            if (val === null || val === undefined || val === "") return null;
            if (typeof val === 'string') {
                const cleaned = val.replace(/[$,\s]/g, '');
                if(cleaned === "") return null;
                const num = parseFloat(cleaned);
                return isNaN(num) ? null : num;
            }
            return val; 
        }

        function wrapInTilt(content, style = "") {
             return `<div class="text-wrapper"><span class="text-content" style="${style}">${content}</span></div>`;
        }

        function formatTextCell(cell) {
            const val = cell.getValue();
            if(val === null || val === undefined) return "";
            return wrapInTilt(val);
        }

        function updateResultCounter(activeCount, totalCount) {
            const t = translations[currentLang];
            const el = document.getElementById("results-counter");
            if(el) el.innerHTML = `${t.loading.replace('...', '')}: <b>${activeCount}</b> <span style="font-size:0.8em; color:#666;">(of ${totalCount})</span>`;
        }

        function refreshCounter() {
            if(table) {
                const activeRows = table.getData("active");
                updateResultCounter(activeRows.length, totalDataCount);
            }
        }

        function updateTableTravelData() {
            if(table) {
                table.redraw(true); 
                const currentSort = table.getSorters()[0];
                if(currentSort && currentSort.field === "calculatedTotal") {
                    table.setSort("calculatedTotal", currentSort.dir);
                }
                if(currentSort && currentSort.field === "calculatedSavings") {
                    table.setSort("calculatedSavings", currentSort.dir);
                }
            }
        }

        // --- ANALYTICS LOGIC ---
        function updateAnalytics(data) {
            const container = document.getElementById('analytics-area');
            const locations = ['China', 'Japan', 'Korea'];
            const t = translations[currentLang];
            
            // Stats buckets
            let stats = {
                'China': { sumPrice: 0, countPrice: 0, sumFollowers: 0, countFollowers: 0, totalCostumes: 0, cssClass: 'theme-china', prices: [] },
                'Japan': { sumPrice: 0, countPrice: 0, sumFollowers: 0, countFollowers: 0, totalCostumes: 0, cssClass: 'theme-japan', prices: [] },
                'Korea': { sumPrice: 0, countPrice: 0, sumFollowers: 0, countFollowers: 0, totalCostumes: 0, cssClass: 'theme-korea', prices: [] }
            };

            // Process Data
            data.forEach(row => {
                const loc = row.country;
                if (stats[loc]) {
                    // Price Stats
                    if (row.price !== null && !isNaN(row.price)) {
                        stats[loc].sumPrice += row.price;
                        stats[loc].countPrice++;
                        stats[loc].prices.push(row.price);
                    }
                    // Follower Stats
                    if (row.followers !== null && !isNaN(row.followers)) {
                        stats[loc].sumFollowers += row.followers;
                        stats[loc].countFollowers++;
                    }
                    // Total Costumes (Partials + Full) for this specific location
                    stats[loc].totalCostumes += (row.partials || 0) + (row.fullSuits || 0);
                }
            });

            // Calculate Peaks & Bins
            locations.forEach(loc => {
                const s = stats[loc];
                if (s.prices.length > 0) {
                    const sorted = s.prices.sort((a,b)=>a-b);
                    const x = d3.scaleLinear().domain(d3.extent(sorted)).range([0, 300]);
                    const histogram = d3.bin().domain(x.domain()).thresholds(x.ticks(15));
                    s.bins = histogram(sorted);
                    
                    // Find bin with highest frequency
                    let maxBin = s.bins[0];
                    s.bins.forEach(bin => {
                        if(bin.length > maxBin.length) maxBin = bin;
                    });
                    s.peakLow = maxBin.x0;
                    s.peakHigh = maxBin.x1;
                } else {
                    s.bins = [];
                    s.peakLow = 0; s.peakHigh = 0;
                }
            });


            // Generate HTML
            let html = '';
            locations.forEach(loc => {
                const s = stats[loc];
                const avgPrice = s.countPrice > 0 ? Math.round(s.sumPrice / s.countPrice) : 0;
                const avgFollowers = s.countFollowers > 0 ? Math.round(s.sumFollowers / s.countFollowers) : 0;
                const fmtFollowers = avgFollowers > 999 ? (avgFollowers/1000).toFixed(1) + 'k' : avgFollowers;

                // Peak Format
                const peakStr = (s.peakLow && s.peakHigh) 
                    ? `${formatCurrency(s.peakLow)} - ${formatCurrency(s.peakHigh)}`
                    : "N/A";

                const svgId = `curve-${loc}`;
                const locName = t[loc.toLowerCase()];

                html += `
                <div class="promo-card ${s.cssClass}">
                    <svg id="${svgId}" class="promo-bg-curve-container" viewBox="0 0 300 100" preserveAspectRatio="none"></svg>
                    
                    <div class="promo-content-layer">
                        <div class="promo-left">
                            <div class="promo-title">${locName}</div>
                            
                            <div class="promo-stat-large">${formatCurrency(avgPrice)}</div>
                            <div class="promo-sub">${t.avgPrice}<br>${t.basedOn} ${s.totalCostumes.toLocaleString()} ${t.recorded}</div>
                            
                            <hr class="promo-divider">
                            
                            <div class="promo-stat-large" style="font-size:1.8em;">${fmtFollowers}</div>
                            <div class="promo-sub">${t.avgFollowers}</div>
                        </div>

                        <div class="promo-right">
                             <div class="peak-label">${t.mostCommon}</div>
                             <div class="peak-range">${peakStr}</div>
                             <div class="promo-sub">${t.majority}</div>
                        </div>
                    </div>
                </div>`;
            });

            container.innerHTML = html;

            // DRAW CURVES WITH D3 (Using pre-calced bins)
            locations.forEach(loc => {
                const s = stats[loc];
                if (!s.bins || s.bins.length < 2) return; 

                const svg = d3.select(`#curve-${loc}`);
                const width = 300;
                const height = 100;

                const x = d3.scaleLinear()
                    .domain([s.bins[0].x0, s.bins[s.bins.length-1].x1])
                    .range([0, width]);

                const y = d3.scaleLinear()
                    .domain([0, d3.max(s.bins, d => d.length)])
                    .range([height, 0]);

                const area = d3.area()
                    .x(d => x(d.x0 + (d.x1 - d.x0) / 2)) 
                    .y0(height)
                    .y1(d => y(d.length))
                    .curve(d3.curveBasis); 

                svg.append("path")
                    .datum(s.bins)
                    .attr("class", "promo-bg-curve")
                    .attr("d", area);
            });
        }

        function initTable(data) {
            // Clear if existing
            if(table) { table.destroy(); }
            const t = translations[currentLang];

            table = new Tabulator("#creator-table", {
                data: data,
                layout: "fitData",
                movableColumns: true,
                resizableColumns: true,
                placeholder:"No Data Available",
                height: "100%", 
                initialSort:[ {column:"rank", dir:"asc"} ],
                dataFiltered: function(filters, rows) {
                    updateResultCounter(rows.length, totalDataCount);
                },
                columns: [
                    { title: t.colRow, field:"rank", visible:true, sorter:"number" },
                    { title: t.colFreight, field: "shipOrFly", visible:false, sorter: "number" },
                    { title: t.colAesthetic, field:"aesthetic", visible:false },
                    { title: t.colMaker, field:"maker", formatter: formatTextCell, cssClass: "text-cell" },
                    { 
                        title: t.colLogo, field:"logo", hozAlign:"center", width:90, 
                        formatter:function(cell){
                            const val = cell.getValue();
                            return val ? `<div class="logo-box" data-src="${val}" style="background-image:url('${val}');"></div>` : "";
                        }
                    },
                    { title: t.colLoc, field:"country", formatter: formatTextCell, cssClass: "text-cell" },
                    { 
                        title: t.colLink, field:"link", hozAlign:"center",
                        formatter: function(cell) {
                            const url = cell.getValue();
                            if(!url) return "";
                            const linkHtml = `<a href="${url}" target="_blank" class="animated-link">${url}</a>`;
                            return wrapInTilt(linkHtml, "background:none; animation:none; -webkit-text-fill-color:initial; color:inherit;");
                        }
                    },
                    { 
                        title: t.colPreview, field: "previewImages", hozAlign: "center", width: 200,
                        formatter: function(cell) {
                           const imageUrls = cell.getValue();
                           if (!imageUrls || imageUrls.length === 0) return "";
                           const container = document.createElement('div');
                           container.className = 'preview-container';
                           imageUrls.forEach((url, index) => {
                               const box = document.createElement('div'); box.className = 'preview-box';
                               const thumbUrl = `https://wsrv.nl/?url=${encodeURIComponent(url)}&w=60&h=60&output=webp&q=80`;
                               box.style.backgroundImage = `url('${thumbUrl}')`;
                               box.setAttribute('data-image-index', index);
                               box.setAttribute('data-src', url); 
                               container.appendChild(box);
                           });
                           return container;
                        }
                    },
                    { title: t.colStatus, field:"status", formatter: formatTextCell, cssClass: "text-cell" },
                    { 
                        title: t.colSpecialty, field:"specialty", width: 300,
                        formatter: function(cell) {
                            const val = cell.getValue(); if (!val) return "";
                            const tags = val.split(',').map(t => t.trim()).filter(t => t);
                            const wrapper = document.createElement('div'); wrapper.className = 'tag-wrapper';
                            tags.forEach(tag => {
                                const span = document.createElement('span'); span.className = 'specialty-tag';
                                span.textContent = tag;
                                span.onclick = function(e) { e.stopPropagation(); addSpecialtyFilter(tag); };
                                wrapper.appendChild(span);
                            });
                            return wrapper;
                        }
                    },
                    { title: t.colPartials, field:"partials", visible:false, hozAlign:"right", sorter:"number", formatter:function(cell){ return cell.getValue() !== null ? wrapInTilt(cell.getValue()) : ""; } },
                    { title: t.colFull, field:"fullSuits", visible:false, hozAlign:"right", sorter:"number", formatter:function(cell){ return cell.getValue() !== null ? wrapInTilt(cell.getValue()) : ""; } },
                    { title: t.colFursuits, field:"fursuits", hozAlign:"right", sorter:"number", formatter:function(cell){ return cell.getValue() !== null ? wrapInTilt(cell.getValue()) : ""; } },
                    { title: t.colPort, field:"portfolio", visible:false, hozAlign:"right", sorter:"number", formatter:function(cell){ return cell.getValue() !== null ? wrapInTilt(cell.getValue()) : ""; } },
                    { title: t.colFollowers, field:"followers", hozAlign:"right", sorter:"number", formatter:function(cell){ return cell.getValue() !== null ? wrapInTilt(cell.getValue().toLocaleString()) : ""; } },

                    { 
                        title: t.colPrice, field:"price", hozAlign:"right", sorter:"number",
                        sorterParams:{ alignEmptyValues:"bottom" },
                        formatter:function(cell){
                            const val = cell.getValue();
                            return val !== null ? wrapInTilt(formatCurrency(val)) : "---";
                        }
                    },
                    { title: t.colTariff, field: "tariff", hozAlign: "right", sorter: "number", formatter: function(cell) { return cell.getValue() ? wrapInTilt(formatCurrency(cell.getValue())) : "---"; } },
                    { title: t.colTotalShip, field: "ship", hozAlign: "right", sorter: "number", formatter: function(cell) { return cell.getValue() ? wrapInTilt(formatCurrency(cell.getValue())) : "---"; } },
                    {
                        title: t.colEstTravel, field: "calculatedTravel", visible:false, hozAlign: "right",
                        formatter: function(cell) {
                            if(globalTravelCost === 0) return "---";
                            return wrapInTilt(formatCurrency(globalTravelCost), "color:#00E676");
                        }
                    },
                    {
                        title: t.colTotalPick, field: "calculatedTotal", hozAlign: "right", sorter: "number",
                        accessor: function(value, data) {
                            const price = data.price || 0;
                            if(globalTravelCost === 0 || price === 0) return 0;
                            const duty = Math.max(0, (price - 800) * 0.03);
                            return price + globalTravelCost + duty;
                        },
                        formatter: function(cell) {
                            const price = cell.getData().price || 0;
                            if(globalTravelCost === 0 || price === 0) return "---";
                            const duty = Math.max(0, (price - 800) * 0.03);
                            const total = price + globalTravelCost + duty;
                            return wrapInTilt(formatCurrency(total), "color:darkorange; font-weight:bold");
                        }
                    },
                    {
                        title: t.colSavings, field: "calculatedSavings", hozAlign: "right", sorter: "number",
                        accessor: function(value, data) {
                            const ship = data.ship || 0;
                            const price = data.price || 0;
                            if (globalTravelCost === 0 || ship === 0 || price === 0) return -9999999;
                            const duty = Math.max(0, (price - 800) * 0.03);
                            const totalPickUp = price + globalTravelCost + duty;
                            return ship - totalPickUp;
                        },
                        formatter: function(cell) {
                            if(globalTravelCost === 0) return "---";
                            const data = cell.getData();
                            const ship = data.ship || 0;
                            const price = data.price || 0;
                            if(ship === 0 || price === 0) return "---";
                            const duty = Math.max(0, (price - 800) * 0.03);
                            const totalPickUp = price + globalTravelCost + duty;
                            const savings = ship - totalPickUp;
                            const el = cell.getElement();
                            el.style.fontWeight = "bold";
                            const color = savings > 0 ? "#00E676" : "#ff5252";
                            return wrapInTilt(formatCurrency(savings), `color:${color}; font-weight:bold`);
                        }
                    }
                ]
            });
        }

        function loadTableData(url) {
             const t = translations[currentLang];
             document.getElementById("results-counter").innerHTML = t.loading;
             Papa.parse(url, {
                download: true, header: true, dynamicTyping: true,
                error: function(err) {
                    console.error("CSV Error:", err);
                    document.getElementById("results-counter").innerHTML = "<span style='color:red'>Error loading data.</span>";
                },
                complete: function(results) {
                    const data = results.data.map(row => ({
                        rank: cleanNumber(row['Rank']),
                        maker: row['Maker'],
                        logo: (row['Logo'] && row['Logo'].match(/=IMAGE\("(.+)"\)/)) ? row['Logo'].match(/=IMAGE\("(.+)"\)/)[1] : row['Logo'],
                        makerType: row['Maker Type'],
                        link: row['Link'],
                        previewImages: row['Preview'] ? row['Preview'].split(/[\s,]+/).filter(u=>u.startsWith('http')) : [],
                        price: cleanNumber(row['$ Price']),
                        shipOrFly: cleanNumber(row['$ Ship or Fly'] || row['$ Freight'] || row['Freight']),
                        tariff: cleanNumber(row['$ Tariff (2025)'] || row['$ Tariff'] || row['Tariff']),
                        ship: cleanNumber(row['$ Ship'] || row['Ship']),
                        aesthetic: row['Aesthetic'],
                        status: row['Status'],
                        specialty: row['Specialty'],
                        partials: cleanNumber(row['Partials']),
                        fullSuits: cleanNumber(row['Full Suits']), 
                        portfolio: cleanNumber(row['Fursuits']),
                        fursuits: cleanNumber(row['Fursuits']),
                        country: row['Location'], 
                        followers: cleanNumber(row['Followers']),
                        acctAge: cleanNumber(row['Acct Age']),
                    })).filter(row => row.maker); 
                    
                    loadedData = data; // Save for language switching
                    totalDataCount = data.length;
                    
                    // UPDATE ANALYTICS
                    updateAnalytics(data);

                    initTable(data);
                    setTimeout(() => updateResultCounter(data.length, data.length), 100);

                    const slider = document.getElementById('price-slider');
                    if(slider && slider.noUiSlider) {
                         slider.noUiSlider.set([2000, 10000]);
                    }
                }
            });
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            // Buttons
            const btnFull = document.getElementById('btn-full');
            const btnPartial = document.getElementById('btn-partial');
            
            btnFull.addEventListener('click', () => {
                btnFull.classList.add('active');
                btnPartial.classList.remove('active');
                loadTableData(csvUrlFull);
            });
            
            btnPartial.addEventListener('click', () => {
                if (!csvUrlPartial) {
                    alert("Please configure the Partial Suits CSV Link in the code!");
                    return;
                }
                btnPartial.classList.add('active');
                btnFull.classList.remove('active');
                loadTableData(csvUrlPartial);
            });

            document.getElementById('check-visa').addEventListener('change', recalcCosts);
            document.getElementById('check-flight').addEventListener('change', recalcCosts);
            document.getElementById('check-tourism').addEventListener('change', recalcCosts);

            const headerText = document.getElementById('header-text');
            const h1 = document.querySelector('h1'); 
            
            let comboEl = document.getElementById('combo-counter');
            if (!comboEl) {
                comboEl = document.createElement('span');
                comboEl.id = 'combo-counter';
                headerText.appendChild(comboEl);
            }

            let starInterval;
            function createStar() {
                const star = document.createElement('div'); star.className = 'star-particle';
                star.textContent = '★'; 
                const rect = headerText.getBoundingClientRect();
                star.style.left = (Math.random() * window.innerWidth) + 'px';
                star.style.top = (rect.bottom - 10) + 'px';
                star.style.fontSize = (0.8 + Math.random() * 0.8) + 'em';
                document.body.appendChild(star);
                setTimeout(() => { star.remove(); }, 1500);
            }

            function createExplosion() {
                const rect = h1.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const scorch = document.createElement('div'); scorch.className = 'scorch-mark'; h1.appendChild(scorch); 
                const flash = document.createElement('div'); flash.className = 'blast-flash'; h1.appendChild(flash);
                setTimeout(() => flash.remove(), 500);
                document.body.classList.add('shake-active');
                setTimeout(() => document.body.classList.remove('shake-active'), 500);
                for (let i = 0; i < 100; i++) { 
                    const particle = document.createElement('div'); particle.className = 'explosion-particle';
                    particle.style.left = centerX + 'px'; particle.style.top = centerY + 'px';
                    const angle = Math.random() * Math.PI * 2; const velocity = 100 + Math.random() * 200;
                    const tx = Math.cos(angle) * velocity; const ty = Math.sin(angle) * velocity;
                    particle.style.setProperty('--tx', `${tx}px`); particle.style.setProperty('--ty', `${ty}px`);
                    particle.style.backgroundColor = ['#FFD700', '#FF5252', '#FFFFFF', '#FFA500'][Math.floor(Math.random() * 4)];
                    const size = 4 + Math.random() * 6; particle.style.width = `${size}px`; particle.style.height = `${size}px`;
                    document.body.appendChild(particle); setTimeout(() => particle.remove(), 800);
                }
                for (let i = 0; i < 40; i++) {
                    const flame = document.createElement('div'); flame.className = 'flame-particle';
                    flame.style.left = centerX + 'px'; flame.style.top = centerY + 'px';
                    const angle = Math.random() * Math.PI * 2; const velocity = 50 + Math.random() * 100;
                    const tx = Math.cos(angle) * velocity; const ty = Math.sin(angle) * velocity;
                    flame.style.setProperty('--tx', `${tx}px`); flame.style.setProperty('--ty', `${ty}px`);
                    document.body.appendChild(flame); setTimeout(() => flame.remove(), 600);
                }
            }

            headerText.addEventListener('mouseenter', () => { 
                if (isExploded) return; 
                starInterval = setInterval(createStar, 50);
                clearTimeout(comboTimeout);
                if (comboCount >= 99) {
                    createExplosion(); comboCount = 0; comboEl.style.display = 'none'; headerText.style.visibility = 'hidden'; isExploded = true; return;
                }
                comboCount++;
                if (comboCount >= 2) {
                    comboEl.textContent = `x${comboCount}`; comboEl.style.opacity = '1';
                    const scale = 1 + (comboCount * 0.1); const safeScale = Math.min(scale, 4);
                    comboEl.style.setProperty('--scale', safeScale);
                    if(comboCount > 50) comboEl.style.color = '#FFD700'; else if(comboCount > 20) comboEl.style.color = '#00FFFF';
                    else if(comboCount > 10) comboEl.style.color = '#FF00FF'; else comboEl.style.color = '#FF5252'; 
                    comboEl.style.animation = 'none'; comboEl.offsetHeight; 
                    comboEl.style.animation = 'combo-shake 0.3s cubic-bezier(.36,.07,.19,.97) both';
                }
                comboTimeout = setTimeout(() => { comboCount = 0; comboEl.style.opacity = '0'; }, 2000);
            });
            headerText.addEventListener('mouseleave', () => { clearInterval(starInterval); });

            const input = document.getElementById('specialty-input');
            const applyBtn = document.getElementById('specialty-apply-btn');
            const clearBtn = document.getElementById('specialty-clear-btn');
            input.addEventListener("keydown", function(e){
                if(e.key === "Enter"){ addSpecialtyFilter(this.value); this.value = ""; }
            });
            applyBtn.onclick = applySpecialtyFilters;
            clearBtn.onclick = clearSpecialtyFilters;

            // Initial Load
            loadTableData(csvUrlFull);
            
            // Init Slider (Once)
            const slider = document.getElementById('price-slider');
            if(slider) {
                noUiSlider.create(slider, {
                    start: [2000, 10000], connect: true, range: { 'min': 2000, 'max': 10000 },
                    step: 500, tooltips: false,
                    pips: { mode: 'steps', density: 6, format: { to: v => '$' + v/1000 + 'k' } }
                });
                const updateTableFilter = () => {
                    const values = slider.noUiSlider.get();
                    filterState.priceMin = parseInt(values[0]);
                    filterState.priceMax = parseInt(values[1]);
                    filterState.showNA = document.getElementById('show-na-prices').checked;
                    // Format Label
                    document.getElementById('price-values').innerText = 
                        `${formatCurrency(filterState.priceMin)} - ${formatCurrency(filterState.priceMax)}`;
                    updateTableFilters();
                };
                slider.noUiSlider.on('update', updateTableFilter);
                document.getElementById('show-na-prices').addEventListener('change', updateTableFilter);
                document.getElementById('reset-price-btn').addEventListener('click', function(){
                    slider.noUiSlider.set([2000, 10000]);
                    document.getElementById('show-na-prices').checked = true;
                });
            }

            document.getElementById('filter-location').addEventListener('change', function() {
                filterState.location = this.value;
                updateTableFilters();
            });

            document.getElementById('filter-status').addEventListener('change', function() {
                filterState.status = this.value;
                updateTableFilters();
            });

            // LANGUAGE LISTENER
            document.getElementById('language-selector').addEventListener('change', function() {
                currentLang = this.value;
                applyLanguage();
            });
        });

        // Tooltip & Hover Logic
        const tooltipEl = document.getElementById("image-tooltip");
        let lastTiltCell = null;
        let currentHoverBox = null; 

        document.addEventListener('mousemove', e => {
            const target = e.target;
            const box = target.closest('.preview-box') || target.closest('.logo-box');
            
            if(box) {
                let sizeVmin = 60; 
                if (box.classList.contains('logo-box')) {
                    sizeVmin = 48;
                }

                tooltipEl.style.width = sizeVmin + 'vmin';
                tooltipEl.style.height = sizeVmin + 'vmin';

                if (box !== currentHoverBox) {
                    currentHoverBox = box;
                    let url = box.getAttribute('data-src'); 
                    if(url) {
                        if(box.classList.contains('preview-box')) {
                             url = `https://wsrv.nl/?url=${encodeURIComponent(url)}&w=600&h=600&output=webp&q=80`;
                        }
                        tooltipEl.style.backgroundImage = `url('${url}')`;
                        tooltipEl.style.display = 'flex'; 
                        requestAnimationFrame(() => { tooltipEl.style.opacity = '1'; });

                        const oldHud = tooltipEl.querySelector('.tooltip-hud');
                        if(oldHud) oldHud.remove();

                        if (box.classList.contains('preview-box')) {
                            const index = parseInt(box.getAttribute('data-image-index'));
                            const container = box.parentNode;
                            const total = container.children.length;
                            if (total > 1) {
                                const hud = document.createElement('div');
                                hud.className = 'tooltip-hud';
                                for(let i=0; i<total; i++) {
                                    const dot = document.createElement('div');
                                    dot.className = 'hud-box' + (i === index ? ' active' : '');
                                    hud.appendChild(dot);
                                }
                                tooltipEl.appendChild(hud);
                            }
                        }
                    }
                }
                const tooltipWidth = tooltipEl.offsetWidth;
                const tooltipHeight = tooltipEl.offsetHeight;
                const offset = 20;

                let left = e.clientX + offset;
                let top = e.clientY + offset;

                if (left + tooltipWidth > window.innerWidth) {
                    left = e.clientX - tooltipWidth - offset;
                }
                if (top + tooltipHeight > window.innerHeight) {
                    top = e.clientY - tooltipHeight - offset;
                }
                if (left < 0) left = 10; 
                if (top < 0) top = 10;

                tooltipEl.style.left = left + 'px';
                tooltipEl.style.top = top + 'px';

            } else {
                if (currentHoverBox) {
                    currentHoverBox = null;
                    if (tooltipEl.style.opacity !== '0') {
                        tooltipEl.style.opacity = '0';
                        setTimeout(() => { 
                            if(tooltipEl.style.opacity === '0') {
                                tooltipEl.style.display = 'none'; 
                                const oldHud = tooltipEl.querySelector('.tooltip-hud');
                                if(oldHud) oldHud.remove();
                            }
                        }, 200);
                    }
                }
            }

            const cell = target.closest('.tabulator-cell');
            if (lastTiltCell && lastTiltCell !== cell) {
                const oldWrapper = lastTiltCell.querySelector('.text-wrapper');
                if (oldWrapper) oldWrapper.style.transform = '';
                lastTiltCell.style.transform = 'none';
                lastTiltCell.classList.remove('active-tilt');
                lastTiltCell = null;
            }

            if (cell) {
                const isInteractive = cell.querySelector('.tag-wrapper'); 
                if (!isInteractive) {
                    lastTiltCell = cell;
                    cell.classList.add('active-tilt');
                    const rect = cell.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    const mouseX = e.clientX - centerX;
                    const mouseY = e.clientY - centerY;
                    
                    const rotateX = -1 * (mouseY / (rect.height / 2)) * 10; 
                    const rotateY = (mouseX / (rect.width / 2)) * 10;
                    
                    const wrapper = cell.querySelector('.text-wrapper');
                    const transformString = `perspective(500px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.15)`;
                    
                    if (wrapper) { 
                        wrapper.style.transform = `translateY(-50%) ${transformString}`; 
                    } else { 
                         cell.style.transform = `perspective(500px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.05)`;
                    }
                }
            }
        });
    </script>
</body>
</html>